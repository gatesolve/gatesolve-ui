{"version":3,"sources":["map-style.ts","components/Pin.tsx","components/Triangle.tsx","components/UserPosition.tsx","components/GeolocateControl.tsx","planner.ts","overpass.ts","mapbox-utils.ts","RoutableTilesToGeoJSON.js","minimal-xyz-viewer.js","App.tsx"],"names":["routeLineLayer","id","type","layout","paint","filter","routeImaginaryLineLayer","routePointLayer","buildingHighlightLayer","allEntrancesLayers","minzoom","maxzoom","concat","anchors","flatMap","angle","index","length","anglesToAnchors","routePointSymbolLayer","SVG_PATH","pinAsSVG","size","style","Pin","height","fill","stroke","dataTestId","data-testid","viewBox","pointerEvents","d","cursor","gradientTransform","offset","stopColor","stopOpacity","triangleAsSVG","UserPosition","width","strokeWidth","position","cx","cy","r","GeolocateControl","onGeolocate","onGeolocateError","positionOptions","enableHighAccuracy","timeout","onEnable","onDisable","enableOnMount","useState","window","navigator","geolocation","isGeolocationSupported","permissions","isPermissionsSupported","permissionState","setPermissionState","watchID","setWatchId","hasBeenUsed","setHasBeenUsed","startWatching","isInitiatedByUser","watchPosition","stopWatching","clearWatch","showWarningOfDeniedGeolocation","console","log","useEffect","query","name","then","permissionStatus","state","onchange","this","catch","error","isClickingAllowed","isGeolocationOn","element","ariaLabel","buttonClassName","className","aria-label","aria-pressed","onContextMenu","event","preventDefault","onClick","assert","undefined","aria-hidden","extractGeometry","path","coordinates","obstacles","obstacleWays","Map","imaginaryWays","legs","getSteps","forEach","step","startLocation","stopLocation","node","context","through","definedTags","has","set","get","push","longitude","latitude","replace","freeformTags","Array","from","values","geometryToGeoJSON","origin","targets","entrances","routeGeometries","features","geometry","properties","color","target","lon","lat","entrance","ref","tags","opacity","imaginary","callback","a","Planner","planner","setProfileID","process","to","take","on","completePath","geoJSON","getMapSize","mapboxgl","getContainer","clientWidth","clientHeight","entranceToLabel","house","find","tag","startsWith","substring","unit","json","nodes","i","lngLat","entranceLabel","splitIndex","indexOf","feats","item","nodeIds","map","nodeId","isWayClockwise","turfBooleanClockwise","turfLineString","xy","xyPrev","xyNext","bearingPrev","turfBearing","bearingNext","entranceAngle","Math","abs","min","adaptedAngle","cos","PI","sin","extractWays","Object","DIAMETER","WEBMERCATOR_R","getVisibleTiles","center","zoom","centerm","lonlat","x","sinlat","y","mercatorProject","centerpx","pow","bbox","floor","ceil","tiles","px","py","latLngToDestination","latLng","destinationToLatLng","destination","initialState","route","highlights","viewport","bearing","pitch","isOriginExplicit","isGeolocating","geolocationPosition","popupCoordinates","routableTiles","metropolitanAreaCenter","transformRequest","originalURL","url","distance","turfDistance","units","parseLatLng","text","parts","split","Number","isNaN","fitBounds","viewportOptions","latLngs","WebMercatorViewport","inputs","minLng","maxLng","max","minLat","maxLat","padding","top","bottom","left","right","maxZoom","App","useRef","geocoder","current","getMap","iconId","renderSVG","shape","svgData","imageId","ratio","devicePixelRatio","canvas","document","createElement","ctx","getContext","img","Image","svgDataUrl","encodeURIComponent","onload","Error","drawImage","addImage","getImageData","pixelRatio","src","addImageSVG","urlMatch","useRouteMatch","setState","fitMap","mapWidth","mapHeight","zoomMultiplier","tilesetZoomLevel","visibleTiles","key","prevState","fetch","response","body","routableTilesToGeoJSON","newRoutableTiles","params","extendedViewport","history","useHistory","snackbarFunctions","useSnackbar","enqueueSnackbar","closeSnackbar","location","pathname","URL","searchParams","append","toString","elements","queryEntrances","result","snackbar","message","variant","persist","anchorOrigin","vertical","horizontal","action","Button","rel","href","IconButton","Close","calculatePlan","geojson","extendedGeojson","handleMapClick","feature","queryRenderedFeatures","point","sourceLayer","toJSON","lng","sources","highlightFirstSuggestion","inputProps","placeholder","onSuggestionSelected","suggestion","source_id","pointsToFit","mapStyle","onViewportChange","onHover","mapboxOverlaysElement","querySelector","onContextmenu","isFirstPosition","coords","updateBase","entries","tile","data","layer","source","draggable","onDragEnd","clear","open","closeButton","closeOnClick","textAlign","k","includes","v","backgroundColor"],"mappings":"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","file":"static/js/App.35681b0d.chunk.js","sourcesContent":["import type { LayerProps } from \"react-map-gl\"; // eslint-disable-line import/no-extraneous-dependencies\nimport type { Expression } from \"mapbox-gl\";\n\nconst anglesToAnchors = (): Array<string | number> => {\n  const offset = 0;\n  const angles = [22.5, 67.5, 112.5, 157.5, 202.5, 247.7, 292.5, 337.5];\n\n  const anchors = [\n    \"top\",\n    \"top-right\",\n    \"right\",\n    \"bottom-right\",\n    \"bottom\",\n    \"bottom-left\",\n    \"left\",\n    \"top-left\",\n  ];\n\n  const initialStep: Array<string | number> = [anchors[offset]];\n  const ret = initialStep.concat(\n    angles.flatMap((angle, index) => {\n      return [angle, anchors[(offset + index + 1) % anchors.length]] as Array<\n        string | number\n      >;\n    })\n  );\n\n  return ret;\n};\n\nexport const routeLineLayer: LayerProps = {\n  id: \"route-line\",\n  type: \"line\",\n  layout: {\n    \"line-cap\": \"round\",\n    \"line-join\": \"round\",\n  },\n  paint: {\n    \"line-opacity\": [\"coalesce\", [\"get\", \"opacity\"], 0.8],\n    \"line-width\": 2,\n    \"line-color\": [\"get\", \"color\"],\n  },\n  filter: [\"!\", [\"coalesce\", [\"get\", \"imaginary\"], false]],\n};\n\nexport const routeImaginaryLineLayer: LayerProps = {\n  id: \"route-imaginary-line\",\n  type: \"line\",\n  layout: {\n    \"line-cap\": \"round\",\n    \"line-join\": \"round\",\n  },\n  paint: {\n    \"line-opacity\": [\"coalesce\", [\"get\", \"opacity\"], 0.5],\n    \"line-width\": 5,\n    \"line-color\": [\"get\", \"color\"],\n    \"line-dasharray\": [0, 2],\n  },\n  filter: [\"coalesce\", [\"get\", \"imaginary\"], false],\n};\n\nexport const routePointLayer: LayerProps = {\n  id: \"route-point\",\n  type: \"circle\",\n  paint: {\n    \"circle-opacity\": [\"coalesce\", [\"get\", \"opacity\"], 1],\n    \"circle-radius\": 5,\n    \"circle-color\": [\"get\", \"color\"],\n  },\n  filter: [\"==\", \"Point\", [\"geometry-type\"]],\n};\n\nexport const buildingHighlightLayer: LayerProps = {\n  id: \"building-highlight\",\n  type: \"fill\",\n  paint: {\n    \"fill-opacity\": 0.3,\n    \"fill-color\": \"#99ff99\",\n  },\n};\n\nexport const allEntrancesLayers: Array<LayerProps> = [\n  {\n    id: \"entrance-point\",\n    type: \"circle\",\n    minzoom: 12,\n    maxzoom: 15.999,\n    paint: {\n      \"circle-radius\": [\n        \"interpolate\",\n        [\"linear\"],\n        [\"zoom\"],\n        12, // At zoom 12 or less,\n        1, // circle radius is 1.\n        14, // At zoom 14,\n        2, // circle radius is 2.\n        15, // At zoom 15 or more,\n        3, // circle radius is 3.\n      ],\n      \"circle-color\": \"#64be14\",\n    },\n  },\n  {\n    id: \"entrance-symbol\",\n    type: \"symbol\",\n    minzoom: 16,\n    paint: {\n      \"text-halo-color\": \"#fff\",\n      \"text-color\": \"#64be14\",\n      \"text-halo-width\": 1,\n    },\n    layout: {\n      \"text-field\": [\n        \"format\",\n        // First, the housenumber, without special formatting\n        [\"get\", \"@house-label\"],\n        {},\n        // Next, a separator in the case that there are two labels\n        [\n          \"case\",\n          // If we have both labels,\n          [\"all\", [\"has\", \"@house-label\"], [\"has\", \"@entrance-label\"]],\n          // then separate by a thin space.\n          \"\\u2009\",\n          // Otherwise, no separator.\n          \"\",\n        ],\n        {},\n        // Last, the entrance letter, in bold font\n        [\"get\", \"@entrance-label\"],\n        {\n          \"text-font\": [\"literal\", [\"Klokantech Noto Sans Bold\"]],\n        },\n      ],\n      \"text-font\": [\"Klokantech Noto Sans Regular\"],\n      \"text-size\": 16,\n      \"text-offset\": [\"get\", \"@offset\"],\n      \"text-anchor\": [\"step\", [\"%\", [\"get\", \"@rotate\"], 360]].concat(\n        anglesToAnchors()\n      ) as Expression,\n      \"text-allow-overlap\": true,\n      \"text-ignore-placement\": true,\n      \"icon-image\": \"icon-svg-triangle-14-#64be14-#fff\",\n      \"icon-anchor\": \"bottom\",\n      \"icon-rotate\": [\"get\", \"@rotate\"],\n      \"icon-allow-overlap\": true,\n      \"icon-ignore-placement\": true,\n    },\n  },\n];\n\nexport const routePointSymbolLayer: LayerProps = {\n  id: \"route-point-symbol\",\n  type: \"symbol\",\n  paint: {\n    \"text-color\": \"#000\",\n    \"text-halo-color\": \"#fff\",\n    \"text-halo-width\": 3,\n  },\n  layout: {\n    \"text-field\": [\"get\", \"ref\"],\n    \"text-anchor\": \"center\",\n    \"text-font\": [\"Klokantech Noto Sans Regular\"],\n    \"text-size\": 24,\n    \"text-offset\": [0, -0.05],\n  },\n  filter: [\"==\", \"Point\", [\"geometry-type\"]],\n};\n","import React from \"react\";\n\nexport interface PinProps {\n  height?: string;\n  style?: React.CSSProperties;\n  dataTestId?: string;\n}\n\nconst SVG_VIEWBOX = \"-1 -1 17 17\";\nconst SVG_PATH =\n  \"M7.5 0C5.068 0 2.23 1.486 2.23 5.27c0 2.568 4.054 8.244 5.27 9.73c1.081-1.486 5.27-7.027 5.27-9.73C12.77 1.487 9.932 0 7.5 0z\";\n\nexport const pinAsSVG = (size: number, style: string): string => `\n<svg xmlns=\"http://www.w3.org/2000/svg\"\n  width=\"${size}px\"\n  height=\"${size}px\"\n  style=\"${style}\"\n  viewBox=\"${SVG_VIEWBOX}\"\n>\n  <path d=\"${SVG_PATH}\" />\n</svg>`;\n\nconst Pin: React.FC<PinProps> = ({\n  height = \"50\",\n  style = { fill: \"#444\", stroke: \"none\" },\n  dataTestId,\n}) => {\n  return (\n    <svg\n      data-testid={dataTestId}\n      height={height}\n      style={style}\n      viewBox={SVG_VIEWBOX}\n      pointerEvents=\"none\"\n    >\n      <path\n        fill={`url(#gradient-${style.fill})`}\n        d={SVG_PATH}\n        pointerEvents=\"visiblepainted\"\n        cursor=\"pointer\"\n      />\n      <defs>\n        <linearGradient\n          id={`gradient-${style.fill}`}\n          gradientTransform=\"rotate(90)\"\n        >\n          <stop offset=\"00%\" stopColor=\"#FFFFFF\" stopOpacity=\"0\" />\n          <stop offset=\"100%\" stopColor={style.fill} stopOpacity=\"1\" />\n        </linearGradient>\n      </defs>\n    </svg>\n  );\n};\n\nexport default Pin;\n","const SVG_VIEWBOX = \"-5 -1 25 25\";\nconst SVG_PATH = \"M 8 16 L 0 8 L 16 8 Z\";\n\n// eslint-disable-next-line import/prefer-default-export\nexport const triangleAsSVG = (size: number, style: string): string => `\n<svg xmlns=\"http://www.w3.org/2000/svg\"\n  width=\"${size}px\"\n  height=\"${size}px\"\n  style=\"${style}\"\n  viewBox=\"${SVG_VIEWBOX}\"\n>\n  <path d=\"${SVG_PATH}\" />\n</svg>`;\n","import React from \"react\";\n\nexport interface UserPositionProps {\n  dataTestId?: string;\n  width?: string;\n  height?: string;\n  stroke?: string;\n  strokeWidth?: string;\n}\n\nconst UserPosition: React.FC<UserPositionProps> = ({\n  dataTestId,\n  width = \"40\",\n  height = \"40\",\n  stroke = \"#00afff\",\n  strokeWidth = \"16\",\n}) => (\n  <svg\n    data-testid={dataTestId}\n    width={width}\n    height={height}\n    stroke={stroke}\n    strokeWidth={strokeWidth}\n    viewBox=\"-100 -100 200 200\"\n    fill=\"transparent\"\n    style={{ position: \"absolute\" }}\n  >\n    <circle cx=\"0\" cy=\"0\" r=\"24\" />\n    <circle cx=\"0\" cy=\"0\" r=\"46\" />\n    <circle cx=\"0\" cy=\"0\" r=\"68\" />\n  </svg>\n);\n\nexport default UserPosition;\n","import React, { useState, useEffect } from \"react\";\nimport type { MouseEventHandler } from \"react\";\n\nexport interface GeolocateControlProps {\n  dataTestId?: string;\n  onGeolocate: PositionCallback;\n  onGeolocateError?: PositionErrorCallback;\n  positionOptions?: PositionOptions;\n  onEnable?: (isInitiatedByUser: boolean) => void;\n  onDisable?: () => void;\n  enableOnMount?: boolean;\n}\n\nconst GeolocateControl: React.FC<GeolocateControlProps> = ({\n  dataTestId,\n  onGeolocate,\n  onGeolocateError,\n  positionOptions = { enableHighAccuracy: true, timeout: 6000 },\n  onEnable,\n  onDisable,\n  enableOnMount = true,\n}) => {\n  const [isGeolocationSupported] = useState(\n    window.navigator.geolocation != null\n  );\n  const [isPermissionsSupported] = useState(\n    window.navigator.permissions != null\n  );\n  const [permissionState, setPermissionState] = useState(\n    null as PermissionState | null\n  );\n  const [watchID, setWatchId] = useState(null as number | null);\n  const [hasBeenUsed, setHasBeenUsed] = useState(false);\n\n  const checkGeolocationPermission = (): void => {\n    if (isPermissionsSupported) {\n      window.navigator.permissions\n        .query({ name: \"geolocation\" })\n        .then((permissionStatus) => {\n          setPermissionState(permissionStatus.state);\n          function setPermissionStateOnChange(this: PermissionStatus): void {\n            setPermissionState(this.state);\n          }\n          // eslint-disable-next-line no-param-reassign\n          permissionStatus.onchange = setPermissionStateOnChange;\n        })\n        .catch((error) => {\n          // FIXME: Warn properly\n          // eslint-disable-next-line no-console\n          console.error(\"Permissions API exists but querying it fails:\", error);\n        });\n    }\n  };\n\n  const startWatching = (isInitiatedByUser: boolean): void => {\n    if (isGeolocationSupported && watchID == null) {\n      setWatchId(\n        window.navigator.geolocation.watchPosition(\n          onGeolocate,\n          onGeolocateError,\n          positionOptions\n        )\n      );\n      setHasBeenUsed(true);\n      if (onEnable != null) {\n        onEnable(isInitiatedByUser);\n      }\n    }\n  };\n\n  const stopWatching = (): void => {\n    if (isGeolocationSupported && watchID != null) {\n      /**\n       * Based on reading the Geolocation API spec (\n       * https://www.w3.org/TR/2016/REC-geolocation-API-20161108/#geolocation_interface\n       * ) and trying out in practice on Chromium, one can call clearWatch\n       * regardless of permissions.\n       */\n      window.navigator.geolocation.clearWatch(watchID);\n      setWatchId(null);\n      if (onDisable != null) {\n        onDisable();\n      }\n    }\n  };\n\n  const showWarningOfDeniedGeolocation = (): void => {\n    // FIXME: Inform the user that geolocation is denied.\n    // eslint-disable-next-line no-console\n    console.log(\"Geolocation is denied. Inform the user.\");\n  };\n\n  // Inform the user once if geolocation is not supported.\n  useEffect(() => {\n    if (!isGeolocationSupported) {\n      // FIXME: Warn the user\n      // eslint-disable-next-line no-console\n      console.log(\"Geolocation is not supported. Inform the user.\");\n    }\n  }, [isGeolocationSupported]);\n\n  // Figure out the permissionState.\n  useEffect(() => {\n    if (\n      isGeolocationSupported &&\n      isPermissionsSupported &&\n      permissionState == null\n    ) {\n      checkGeolocationPermission();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Warn the user about denied permission.\n  useEffect(() => {\n    if (permissionState === \"denied\") {\n      showWarningOfDeniedGeolocation();\n      stopWatching();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [permissionState]);\n\n  /**\n   * If Permissions API is supported, only allow clicking once the\n   * PermissionState is known.\n   */\n  const isClickingAllowed = !isPermissionsSupported || permissionState != null;\n  const isGeolocationOn = watchID != null;\n\n  // Start watching on mount if asked.\n  useEffect(() => {\n    if (\n      enableOnMount &&\n      !hasBeenUsed &&\n      isGeolocationSupported &&\n      !isGeolocationOn &&\n      (!isPermissionsSupported ||\n        (permissionState != null && permissionState !== \"denied\"))\n    ) {\n      startWatching(false);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    enableOnMount,\n    hasBeenUsed,\n    isGeolocationSupported,\n    isGeolocationOn,\n    isPermissionsSupported,\n    permissionState,\n  ]);\n\n  const onClick: MouseEventHandler = (event) => {\n    /**\n     * Assume that Geolocation API exists.\n     *\n     * Assume either permissionState is known or the Permissios API is not\n     * supported.\n     */\n    // FIXME: Maybe find a way so this does not need to be remembered.\n    // eslint-disable-next-line no-console\n    console.assert(isGeolocationSupported);\n    // FIXME: Maybe find a way so this does not need to be remembered.\n    // FIXME: Remove these debug asserts\n    // eslint-disable-next-line no-console\n    console.assert(isClickingAllowed);\n    event.preventDefault();\n\n    if (!isGeolocationOn) {\n      if (isPermissionsSupported && permissionState === \"denied\") {\n        // Warn the user again if they press the button.\n        showWarningOfDeniedGeolocation();\n      } else {\n        startWatching(true);\n      }\n    } else {\n      stopWatching();\n    }\n  };\n\n  let element = null;\n  if (isGeolocationSupported) {\n    const ariaLabel = isGeolocationOn\n      ? \"Stop using my location\"\n      : \"Find my location\";\n    const buttonClassName = isGeolocationOn\n      ? \"mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate mapboxgl-ctrl-geolocate-active\"\n      : \"mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate\";\n    element = (\n      <div className=\"mapboxgl-ctrl mapboxgl-ctrl-group mapboxgl-ctrl-bottom-left\">\n        <button\n          type=\"button\"\n          className={buttonClassName}\n          data-testid={dataTestId}\n          aria-label={ariaLabel}\n          aria-pressed={isGeolocationOn}\n          onContextMenu={(event): void => event.preventDefault()}\n          onClick={isClickingAllowed ? onClick : undefined}\n        >\n          <span className=\"mapboxgl-ctrl-icon\" aria-hidden=\"true\" />\n        </button>\n      </div>\n    );\n  }\n  return element;\n};\n\nexport default GeolocateControl;\n","import type {\n  Feature,\n  FeatureCollection,\n  Geometry,\n  GeoJsonProperties,\n} from \"geojson\"; // eslint-disable-line import/no-extraneous-dependencies\n\n// \"./planner-config\" (and PlannerJS) is imported dynamically by calculatePlan\n\nimport { ElementWithCoordinates } from \"./overpass\";\n\ninterface RouteGeometries {\n  coordinates: Array<[number, number]>;\n  obstacles: Array<[number, number]>;\n  obstacleWays: Array<Array<[number, number]>>;\n  imaginaryWays: Array<Array<[number, number]>>;\n}\n\nfunction extractGeometry(\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  path: any\n): RouteGeometries {\n  const coordinates = [] as Array<[number, number]>;\n  const obstacles = [] as Array<[number, number]>;\n  const obstacleWays = new Map();\n  const imaginaryWays = [] as Array<Array<[number, number]>>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  path.legs[0].getSteps().forEach((step: any, index: number) => {\n    /* XXX: Would be nice to get a null step.through from PlannerJS here.\n       Heuristic below: PlannerJS connects the origin and destination to\n       the nearest OSM ways through a node which does not have an id,\n       so the steps whose geometry is not based on an OSM way have\n       nodes without ids at both ends. Additionally, the second step is a\n       false positive if origin and destination connect to same OSM edge.\n     */\n    if (!step.startLocation.id && !step.stopLocation.id && index !== 1) {\n      imaginaryWays.push([\n        [\n          step.startLocation.longitude as number,\n          step.startLocation.latitude as number,\n        ],\n        [\n          step.stopLocation.longitude as number,\n          step.stopLocation.latitude as number,\n        ],\n      ]);\n      return; // guessed segment\n    }\n    const node = step.stopLocation;\n    if (\n      path.context[step.through]?.definedTags[\n        \"https://w3id.org/openstreetmap/terms#highway\"\n      ] === \"https://w3id.org/openstreetmap/terms#Steps\"\n    ) {\n      if (!obstacleWays.has(step.through)) {\n        obstacleWays.set(step.through, []);\n      }\n      obstacleWays\n        .get(step.through)\n        .push(\n          [\n            step.startLocation.longitude as number,\n            step.startLocation.latitude as number,\n          ],\n          [\n            step.stopLocation.longitude as number,\n            step.stopLocation.latitude as number,\n          ]\n        );\n    }\n    if (node.definedTags?.[\"https://w3id.org/openstreetmap/terms#barrier\"]) {\n      // eslint-disable-next-line no-console\n      console.log(\n        step.through,\n        node.definedTags[\n          \"https://w3id.org/openstreetmap/terms#barrier\"\n        ].replace(/^.*#/, \"\"),\n        node.id,\n        node.definedTags,\n        node.freeformTags\n      );\n      obstacles.push([node.longitude as number, node.latitude as number]);\n    }\n    coordinates.push([\n      step.startLocation.longitude as number,\n      step.startLocation.latitude as number,\n    ]);\n    coordinates.push([\n      step.stopLocation.longitude as number,\n      step.stopLocation.latitude as number,\n    ]);\n  });\n  return {\n    coordinates,\n    obstacles,\n    obstacleWays: Array.from(obstacleWays.values()),\n    imaginaryWays,\n  };\n}\n\nexport function geometryToGeoJSON(\n  origin?: [number, number],\n  targets?: Array<ElementWithCoordinates>,\n  entrances?: Array<ElementWithCoordinates>,\n  routeGeometries?: RouteGeometries\n): FeatureCollection {\n  const features = [] as Array<Feature<Geometry, GeoJsonProperties>>;\n  if (origin) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"Point\",\n        coordinates: [origin[1], origin[0]],\n      },\n      properties: {\n        color: \"#00afff\",\n      },\n    });\n  }\n  if (targets) {\n    targets.forEach((target) => {\n      features.push({\n        type: \"Feature\",\n        geometry: {\n          type: \"Point\",\n          coordinates: [target.lon, target.lat],\n        },\n        properties: {\n          color: \"#64be14\",\n        },\n      });\n    });\n  }\n  if (entrances) {\n    entrances.forEach((entrance) => {\n      features.push({\n        type: \"Feature\",\n        geometry: {\n          type: \"Point\",\n          coordinates: [entrance.lon, entrance.lat],\n        },\n        properties: {\n          color: \"#00ffff\",\n          ref: entrance.tags?.[\"ref\"] || entrance.tags?.[\"addr:unit\"],\n          opacity: 0,\n        },\n      });\n    });\n  }\n  if (routeGeometries?.coordinates) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"LineString\",\n        coordinates: routeGeometries.coordinates,\n      },\n      properties: {\n        color: \"#000\",\n      },\n    });\n  }\n  if (routeGeometries?.obstacleWays) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"MultiLineString\",\n        coordinates: routeGeometries.obstacleWays,\n      },\n      properties: {\n        color: \"#dc0451\",\n        opacity: 1,\n      },\n    });\n  }\n  if (routeGeometries?.imaginaryWays) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"MultiLineString\",\n        coordinates: routeGeometries.imaginaryWays,\n      },\n      properties: {\n        color: \"#000\",\n        imaginary: true,\n      },\n    });\n  }\n  if (routeGeometries?.obstacles) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"MultiPoint\",\n        coordinates: routeGeometries.obstacles,\n      },\n      properties: {\n        color: \"#dc0451\",\n        ref: \"!\",\n      },\n    });\n  }\n  return {\n    type: \"FeatureCollection\",\n    features,\n  };\n}\n\nexport default async function calculatePlan(\n  origin: [number, number],\n  targets: Array<ElementWithCoordinates>,\n  callback: (f: FeatureCollection) => void\n): Promise<void> {\n  const { Planner } = await import(\n    /* webpackChunkName: \"planner-config\" */\n    /* webpackPrefetch: true */\n    \"./planner-config\"\n  );\n  targets.forEach((target) => {\n    const planner = new Planner();\n    // XXX setProfileID requires URL to start with scheme, so guess\n    const protocol = process.env.NODE_ENV === \"production\" ? \"https\" : \"http\";\n    planner\n      .setProfileID(`${protocol}://${process.env.PUBLIC_URL}/delivery.json`)\n      .query({\n        from: { latitude: origin[0], longitude: origin[1] },\n        to: { latitude: target.lat, longitude: target.lon },\n      })\n      .take(1)\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      .on(\"data\", async (path: any) => {\n        const completePath = await planner.completePath(path);\n        // eslint-disable-next-line no-console\n        console.log(\"Plan\", completePath, \"from\", origin, \"to\", target);\n        const routeGeometries = extractGeometry(completePath);\n        const geoJSON = geometryToGeoJSON(\n          origin,\n          [target],\n          undefined,\n          routeGeometries\n        );\n        callback(geoJSON);\n      });\n  });\n}\n","export interface OverpassResponse {\n  version: number;\n  generator: string;\n  osm3s: Osm3S;\n  elements: Element[];\n}\n\nexport interface Osm3S {\n  timestamp_osm_base: Date;\n  copyright: string;\n}\n\nexport type Element =\n  | ElementWithCoordinates\n  | (ElementCore & Partial<Coordinates>);\n\nexport type ElementWithCoordinates = ElementCore & Coordinates;\n\ninterface ElementCore {\n  type: string;\n  id: number;\n  tags?: Tags;\n}\n\nexport interface Coordinates {\n  lat: number;\n  lon: number;\n}\n\nexport interface Tags {\n  entrance?: string;\n  operator?: string;\n  ref?: string;\n  \"addr:unit\"?: string;\n  \"addr:housenumber\"?: string;\n  \"addr:street\"?: string;\n}\n\nconst buildEntranceQuery = (lat: number, lon: number): string => `\n  [out:json][timeout:25];\n  (\n    relation(around:10, ${lat}, ${lon})[building];\n    way(r);\n    way(around:10, ${lat}, ${lon})[building];\n  )->.b;\n  // gather results\n  (\n    node(w.b)[entrance];\n  );\n  // print results\n  out body;\n  >;\n  out skel qt;\n`;\n\nexport const queryEntrances = (\n  target: ElementWithCoordinates\n): Promise<ElementWithCoordinates[]> => {\n  const url = new URL(\"https://overpass.rwqr.org/api/interpreter\");\n  url.searchParams.append(\"data\", buildEntranceQuery(target.lat, target.lon));\n  return fetch(url.toString()).then((response) =>\n    response.json().then((body: OverpassResponse) => {\n      const targets = body.elements.filter(\n        (element) =>\n          element.type === \"node\" &&\n          \"lat\" in element &&\n          element.lat != null &&\n          \"lon\" in element &&\n          element.lon != null &&\n          element.tags &&\n          element.tags.entrance\n      );\n      // FIXME: How to make the compiler deduce this by itself from above?\n      // For example, see https://github.com/Microsoft/TypeScript/issues/16069\n      return targets as ElementWithCoordinates[];\n    })\n  );\n};\n","import { Map } from \"mapbox-gl\";\n\n// eslint-disable-next-line import/prefer-default-export\nexport const addImageSVG = (\n  mapboxgl: Map,\n  imageId: string,\n  svgData: string,\n  size: number\n): void => {\n  const ratio = window.devicePixelRatio;\n\n  const canvas = document.createElement(\"canvas\");\n  canvas.width = ratio * size;\n  canvas.height = ratio * size;\n\n  const ctx = canvas.getContext(\"2d\");\n  const img = new Image(size, size);\n\n  const svgDataUrl = `data:image/svg+xml,${encodeURIComponent(svgData)}`;\n\n  img.onload = (): void => {\n    if (!ctx) {\n      throw Error(\"canvas.getContext failed\");\n    }\n\n    ctx.drawImage(img, 0, 0, ratio * size, ratio * size);\n    mapboxgl.addImage(\n      imageId,\n      ctx.getImageData(0, 0, ratio * size, ratio * size),\n      { pixelRatio: ratio }\n    );\n  };\n\n  img.src = svgDataUrl;\n};\n\nexport const getMapSize = (\n  mapboxgl: Map\n): { width: number; height: number } => ({\n  width: mapboxgl?.getContainer()?.clientWidth,\n  height: mapboxgl?.getContainer()?.clientHeight,\n});\n","// Original source: https://github.com/openplannerteam/leaflet-routable-tiles/blob/master/lib/RoutableTilesToGeoJSON.js\n\nimport {\n  bearing as turfBearing,\n  lineString as turfLineString,\n  booleanClockwise as turfBooleanClockwise,\n} from \"@turf/turf\";\n\nconst offset = 0.2;\n\nvar extractWays = function (json, nodes, feats) {\n  json[\"@graph\"]\n    .filter((item) => {\n      return (\n        item[\"@type\"] === \"osm:Way\"\n        /* FIXME: Implement proper support for multipolygon outlines\n           and then re-enable the following filter:\n             && item[\"osm:hasTag\"]?.find((tag) => tag.startsWith(\"building=\"))\n         */\n      );\n    })\n    .forEach((item) => {\n      //Transform osm:hasNodes to a linestring style thing\n      if (!item[\"osm:hasNodes\"]) {\n        item[\"osm:hasNodes\"] = [];\n      } else if (typeof item[\"osm:hasNodes\"] === \"string\") {\n        item[\"osm:hasNodes\"] = [item[\"osm:hasNodes\"]];\n      }\n      const nodeIds = item[\"osm:hasNodes\"];\n      if (nodeIds.length < 4) {\n        console.log(\"not an area\", item[\"@id\"]);\n        return;\n      }\n      if (nodeIds[0] !== nodeIds[nodeIds.length - 1]) {\n        console.log(\"unclosed\", item[\"@id\"]);\n      }\n      item[\"osm:hasNodes\"].map((nodeId, index, nodeIds) => {\n        const node = feats[nodeId];\n        if (node) {\n          // FIXME: This logic does not consider inner edges of multipolygons:\n          const isWayClockwise = turfBooleanClockwise(\n            turfLineString(nodeIds.map((id) => nodes[id]))\n          );\n          const xy = nodes[nodeId];\n          const xyPrev =\n            index === 0\n              ? nodes[nodeIds[nodeIds.length - 2]]\n              : nodes[nodeIds[index - 1]];\n          const xyNext =\n            index === nodeIds.length - 1\n              ? nodes[nodeIds[1]]\n              : nodes[nodeIds[index + 1]];\n\n          const bearingPrev = turfBearing(xy, xyPrev);\n          const bearingNext = turfBearing(xy, xyNext);\n          const entranceAngle =\n            Math.abs(bearingPrev - bearingNext) / 2 +\n            Math.min(bearingPrev, bearingNext);\n          const adaptedAngle =\n            bearingPrev > bearingNext\n              ? entranceAngle + 270\n              : entranceAngle + 90;\n          const angle = isWayClockwise ? adaptedAngle : adaptedAngle + 180;\n\n          node.properties = {\n            ...node.properties,\n            \"@offset\": [\n              Math.cos((angle / 180) * Math.PI) * offset,\n              Math.sin((angle / 180) * Math.PI) * offset,\n            ],\n            \"@rotate\": (((angle - 90) % 360) + 360) % 360,\n          };\n        }\n        return nodes[nodeId];\n      });\n    });\n};\n\nconst entranceToLabel = function (node) {\n  const house =\n    node[\"osm:hasTag\"]\n      ?.find((tag) => tag.startsWith(\"addr:housenumber=\"))\n      ?.substring(17) || \"\";\n  const ref = node[\"osm:hasTag\"]\n    ?.find((tag) => tag.startsWith(\"ref=\"))\n    ?.substring(4);\n  const unit = node[\"osm:hasTag\"]\n    ?.find((tag) => tag.startsWith(\"addr:unit=\"))\n    ?.substring(10);\n  const entrance = ref || unit || \"\";\n  return {\n    house: house.replace(/ /g, \"\\u2009\"),\n    entrance: entrance.replace(/ /g, \"\\u2009\"),\n  };\n};\n\nexport default function (json) {\n  var entrances = {};\n  var nodes = {};\n  for (var i = 0; i < json[\"@graph\"].length; i++) {\n    let element = json[\"@graph\"][i];\n    if (element[\"geo:lat\"] && element[\"geo:long\"]) {\n      // Store the coordinates of every node for later reference\n      const lngLat = [element[\"geo:long\"], element[\"geo:lat\"]];\n      nodes[element[\"@id\"]] = lngLat;\n\n      if (element[\"osm:hasTag\"]?.find((tag) => tag.startsWith(\"entrance=\"))) {\n        // Create a GeoJSON feature for each entrance\n        const entranceLabel = entranceToLabel(element);\n        const entrance = {\n          id: element[\"@id\"],\n          type: \"Feature\",\n          geometry: {\n            type: \"Point\",\n            coordinates: lngLat,\n          },\n          properties: {\n            \"@id\": element[\"@id\"],\n            \"@entrance-label\": entranceLabel.entrance,\n            \"@house-label\": entranceLabel.house,\n          },\n        };\n        // Store each OSM tag as a feature property\n        // XXX: Could be computed later on demand\n        element[\"osm:hasTag\"].forEach((tag) => {\n          const splitIndex = tag.indexOf(\"=\");\n          entrance.properties[tag.substring(0, splitIndex)] = tag.substring(\n            splitIndex + 1\n          );\n        });\n\n        entrances[entrance.properties[\"@id\"]] = entrance;\n      }\n    }\n  }\n  extractWays(json, nodes, entrances);\n  return {\n    type: \"FeatureCollection\",\n    features: Object.values(entrances),\n  };\n}\n","// Source: https://gist.github.com/jsanz/e8549c7bffd442235a942695ffdaf77d\n\nconst TILE_SIZE = 256;\nconst WEBMERCATOR_R = 6378137.0;\nconst DIAMETER = WEBMERCATOR_R * 2 * Math.PI;\n\nexport function mercatorProject(lonlat) {\n  var x = (DIAMETER * lonlat[0]) / 360.0;\n  var sinlat = Math.sin((lonlat[1] * Math.PI) / 180.0);\n  var y = (DIAMETER * Math.log((1 + sinlat) / (1 - sinlat))) / (4 * Math.PI);\n  return [DIAMETER / 2 + x, DIAMETER - (DIAMETER / 2 + y)];\n}\n// console.log(Mercator.project([-3,41]))\n\nexport function getVisibleTiles(clientWidth, clientHeight, center, zoom) {\n  var centerm = mercatorProject(center);\n  // zoom + centerm -> centerpx\n  var centerpx = [\n    (centerm[0] * TILE_SIZE * Math.pow(2, zoom)) / DIAMETER,\n    (centerm[1] * TILE_SIZE * Math.pow(2, zoom)) / DIAMETER,\n  ];\n\n  // xmin, ymin, xmax, ymax\n  var bbox = [\n    Math.floor((centerpx[0] - clientWidth / 2) / TILE_SIZE),\n    Math.floor((centerpx[1] - clientHeight / 2) / TILE_SIZE),\n    Math.ceil((centerpx[0] + clientWidth / 2) / TILE_SIZE),\n    Math.ceil((centerpx[1] + clientHeight / 2) / TILE_SIZE),\n  ];\n  var tiles = [];\n  //xmin, ymin, xmax, ymax\n  for (let x = bbox[0]; x < bbox[2]; ++x) {\n    for (let y = bbox[1]; y < bbox[3]; ++y) {\n      var [px, py] = [\n        x * TILE_SIZE - centerpx[0] + clientWidth / 2,\n        y * TILE_SIZE - centerpx[1] + clientHeight / 2,\n      ];\n      tiles.push({ x, y, zoom, px, py });\n    }\n  }\n  return tiles;\n}\n","import React, { useState, useEffect, useRef, ReactText } from \"react\";\nimport { useRouteMatch, useHistory } from \"react-router-dom\";\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport type { match } from \"react-router-dom\";\nimport { Button, IconButton } from \"@material-ui/core\";\nimport { Close as CloseIcon } from \"@material-ui/icons\";\nimport { useSnackbar } from \"notistack\";\nimport MapGL, { Popup, Source, Layer, Marker } from \"@urbica/react-map-gl\";\nimport { WebMercatorViewport } from \"viewport-mercator-project\";\nimport type { WebMercatorViewportOptions } from \"viewport-mercator-project\";\nimport { distance as turfDistance } from \"@turf/turf\";\nimport { MapboxGeoJSONFeature } from \"mapbox-gl\";\nimport \"mapbox-gl/dist/mapbox-gl.css\";\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { FeatureCollection } from \"geojson\";\nimport { ReactAutosuggestGeocoder } from \"react-autosuggest-geocoder\";\n\nimport {\n  routePointLayer,\n  routePointSymbolLayer,\n  routeLineLayer,\n  routeImaginaryLineLayer,\n  buildingHighlightLayer,\n  allEntrancesLayers,\n} from \"./map-style\";\nimport Pin, { pinAsSVG } from \"./components/Pin\";\nimport { triangleAsSVG } from \"./components/Triangle\";\nimport UserPosition from \"./components/UserPosition\";\nimport GeolocateControl from \"./components/GeolocateControl\";\nimport calculatePlan, { geometryToGeoJSON } from \"./planner\";\nimport { queryEntrances, ElementWithCoordinates } from \"./overpass\";\nimport { addImageSVG, getMapSize } from \"./mapbox-utils\";\nimport routableTilesToGeoJSON from \"./RoutableTilesToGeoJSON\";\nimport { getVisibleTiles } from \"./minimal-xyz-viewer\";\n\nimport \"./App.css\";\nimport \"./components/PinMarker.css\";\n\nconst maxRoutingDistance = 200; // in meters\n\ntype LatLng = [number, number];\n\ninterface State {\n  viewport: WebMercatorViewportOptions;\n  isOriginExplicit: boolean;\n  origin?: LatLng;\n  destination?: ElementWithCoordinates;\n  entrances?: Array<ElementWithCoordinates>;\n  route: FeatureCollection;\n  highlights?: MapboxGeoJSONFeature | FeatureCollection;\n  isGeolocating: boolean;\n  geolocationPosition: LatLng | null;\n  popupCoordinates: ElementWithCoordinates | null;\n  snackbar?: ReactText;\n  routableTiles: Map<string, FeatureCollection | null>;\n}\n\nconst latLngToDestination = (latLng: LatLng): ElementWithCoordinates => ({\n  id: -1,\n  type: \"node\",\n  lat: latLng[0],\n  lon: latLng[1],\n});\n\nconst destinationToLatLng = (destination: ElementWithCoordinates): LatLng => [\n  destination.lat,\n  destination.lon,\n];\n\nconst initialState: State = {\n  entrances: [],\n  route: geometryToGeoJSON(),\n  highlights: {\n    type: \"FeatureCollection\",\n    features: [],\n  },\n  viewport: {\n    latitude: 60.17,\n    longitude: 24.941,\n    zoom: 15,\n    bearing: 0,\n    pitch: 0,\n  },\n  isOriginExplicit: false,\n  isGeolocating: false,\n  geolocationPosition: null,\n  popupCoordinates: null,\n  routableTiles: new Map(),\n};\n\nconst metropolitanAreaCenter = [60.17066815612902, 24.941510260105133];\n\nconst transformRequest = (originalURL: string): { url: string } => {\n  const url = originalURL.replace(\n    \"https://static.hsldev.com/mapfonts/Klokantech Noto Sans\",\n    \"https://fonts.openmaptiles.org/Klokantech Noto Sans\"\n  );\n  return { url };\n};\n\nconst distance = (from: LatLng, to: LatLng): number =>\n  turfDistance([from[1], from[0]], [to[1], to[0]], { units: \"metres\" });\n\nconst parseLatLng = (text: string | undefined): LatLng | undefined => {\n  if (text) {\n    const parts = text.split(\",\");\n    if (parts.length === 2 && parts[0].length && parts[1].length) {\n      const [lat, lon] = parts.map(Number);\n      if (!Number.isNaN(lat) && lon > -90 && lon < 90) {\n        return [lat, lon];\n      }\n    }\n  }\n  return undefined;\n};\n\nconst fitBounds = (\n  viewportOptions: WebMercatorViewportOptions,\n  latLngs: Array<LatLng | undefined>\n): WebMercatorViewportOptions => {\n  const viewport = new WebMercatorViewport(viewportOptions);\n  const inputs = latLngs.filter((x) => x) as Array<LatLng>;\n  if (!inputs.length) return viewportOptions; // Nothing to do\n  const minLng = Math.min(...inputs.map((x) => x[1]));\n  const maxLng = Math.max(...inputs.map((x) => x[1]));\n  const minLat = Math.min(...inputs.map((x) => x[0]));\n  const maxLat = Math.max(...inputs.map((x) => x[0]));\n  const padding = 20;\n  const markerSize = 50;\n  const occludedTop = 40;\n  const circleRadius = 5;\n  return viewport.fitBounds(\n    [\n      [minLng, minLat],\n      [maxLng, maxLat],\n    ],\n    {\n      padding: {\n        top: padding + occludedTop + markerSize,\n        bottom: padding + circleRadius,\n        left: padding + markerSize / 2,\n        right: padding + markerSize / 2,\n      },\n      maxZoom: 17,\n    } as any // eslint-disable-line @typescript-eslint/no-explicit-any\n    // XXX above: @types/viewport-mercator-project is missing maxZoom\n  );\n};\n\nconst App: React.FC = () => {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const map = useRef<any>(null);\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const geocoder = useRef<any>(null);\n\n  // Install a callback to dynamically create pin icons that our map styles use\n  useEffect(() => {\n    if (!map.current) {\n      return; // No map yet, so nothing to do\n    }\n    const mapboxgl = map.current.getMap();\n    // FIXME: Unclear why this passed type checking before.\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    mapboxgl?.on(\"styleimagemissing\", ({ id: iconId }: any) => {\n      if (!iconId?.startsWith(\"icon-svg-\")) {\n        return; // We only know how to generate certain svg icons\n      }\n      const [, , shape, size, fill, stroke] = iconId.split(\"-\"); // e.g. icon-pin-48-green-#fff\n      let renderSVG;\n      if (shape === \"pin\") {\n        renderSVG = pinAsSVG;\n      } else if (shape === \"triangle\") {\n        renderSVG = triangleAsSVG;\n      } else {\n        return; // Unknown shape\n      }\n      const svgData = renderSVG(size, `fill: ${fill}; stroke: ${stroke}`);\n      addImageSVG(mapboxgl, iconId, svgData, size);\n    });\n  }, [map]);\n\n  const urlMatch = useRouteMatch({\n    path: \"/route/:from?/:to?\",\n  }) as match<{ from: string; to: string }>;\n\n  const [state, setState] = useState(initialState);\n\n  const fitMap = (\n    viewportOptions: WebMercatorViewportOptions,\n    latLngs: Array<LatLng | undefined>\n  ): WebMercatorViewportOptions => {\n    return fitBounds(\n      { ...viewportOptions, ...getMapSize(map.current?.getMap()) },\n      latLngs\n    );\n  };\n\n  useEffect(() => {\n    if (!map.current || !state.viewport.zoom) {\n      return; // Nothing to do yet\n    }\n    if (state.viewport.zoom < 12) return; // minzoom\n\n    const { width: mapWidth, height: mapHeight } = getMapSize(\n      map.current.getMap()\n    );\n\n    // Calculate multiplier for under- or over-zoom\n    const tilesetZoomLevel = 14;\n    const zoomOffset = 1; // tiles are 512px (double the standard size)\n    const zoomMultiplier =\n      2 ** (tilesetZoomLevel - zoomOffset - state.viewport.zoom);\n\n    const visibleTiles = getVisibleTiles(\n      zoomMultiplier * mapWidth,\n      zoomMultiplier * mapHeight,\n      [state.viewport.longitude, state.viewport.latitude],\n      tilesetZoomLevel\n    );\n\n    // Initialise the new Map with nulls and available tiles from previous\n    const routableTiles = new Map();\n    visibleTiles.forEach(({ zoom, x, y }) => {\n      const key = `${zoom}/${x}/${y}`;\n      routableTiles.set(key, state.routableTiles.get(key) || null);\n    });\n\n    setState(\n      (prevState: State): State => {\n        return {\n          ...prevState,\n          routableTiles,\n        };\n      }\n    );\n\n    visibleTiles.map(async ({ zoom, x, y }) => {\n      const key = `${zoom}/${x}/${y}`;\n      if (routableTiles.get(key) !== null) return; // We already have the tile\n      // Fetch the tile\n      const response = await fetch(\n        `https://tile.olmap.org/building-tiles/${zoom}/${x}/${y}`\n      );\n      const body = await response.json();\n      // Convert the tile to GeoJSON\n      const geoJSON = routableTilesToGeoJSON(body) as FeatureCollection;\n      // Add the tile if still needed based on latest state\n      setState(\n        (prevState: State): State => {\n          if (prevState.routableTiles.get(key) !== null) {\n            return prevState; // This tile is not needed anymore\n          }\n          const newRoutableTiles = new Map(prevState.routableTiles);\n          newRoutableTiles.set(key, geoJSON);\n          return {\n            ...prevState,\n            routableTiles: newRoutableTiles,\n          };\n        }\n      );\n    });\n  }, [map.current, state.viewport]); // eslint-disable-line react-hooks/exhaustive-deps\n  // XXX: state.routableTiles is missing above as we only use it as a cache here\n\n  useEffect(() => {\n    /**\n     * FIXME: urbica/react-map-gl does not expose fitBounds and its viewport\n     * does not include width and height which are required by fitBounds from\n     * viewport-mercator-project. This is dirty but seems to work.\n     */\n    if (!map.current) {\n      return; // No map yet, so nothing to do\n    }\n    const { width, height } = getMapSize(map.current.getMap());\n    if (\n      urlMatch &&\n      width != null &&\n      width > 0 &&\n      height != null &&\n      height > 0\n    ) {\n      const origin = parseLatLng(urlMatch.params.from);\n      const destination = parseLatLng(urlMatch.params.to);\n      const extendedViewport = { ...state.viewport, width, height };\n      const viewport = fitBounds(extendedViewport, [origin, destination]);\n      setState(\n        (prevState): State => ({\n          ...prevState,\n          origin,\n          isOriginExplicit: origin != null,\n          destination: destination && latLngToDestination(destination),\n          viewport: { ...prevState.viewport, ...viewport },\n        })\n      );\n    }\n  }, [map]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  const history = useHistory();\n\n  const snackbarFunctions = useSnackbar();\n  // XXX: useSnackbar does not return functions during unit tests\n  const enqueueSnackbar = snackbarFunctions?.enqueueSnackbar;\n  const closeSnackbar = snackbarFunctions?.closeSnackbar;\n\n  useEffect(() => {\n    const destination = state.destination && [\n      state.destination.lat,\n      state.destination.lon,\n    ];\n    const path = `/route/${state.origin}/${destination}/`;\n    if (history.location.pathname !== path) {\n      history.replace(path);\n    }\n  }, [history, state.origin, state.destination]);\n\n  useEffect(() => {\n    if (!state.destination) return; // Nothing to do yet\n    queryEntrances(state.destination)\n      .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error(\"Error while fetching building entrances:\", error);\n        return []; // Proceed as if there was no entrance data\n      })\n      .then((result) => {\n        setState(\n          (prevState): State => {\n            if (!state.destination) return prevState; // XXX Typescript needs this\n            if (prevState.destination !== state.destination) {\n              return prevState;\n            }\n            const entrances = result.length ? result : [state.destination];\n\n            return {\n              ...prevState,\n              entrances,\n            };\n          }\n        );\n      })\n      .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error(\"Error while handling entrances:\", error);\n      });\n  }, [state.destination]);\n\n  // Set off routing calculation when inputs change; collect results in state.route\n  useEffect(() => {\n    if (state.snackbar) closeSnackbar(state.snackbar);\n\n    if (!state.origin || !state.destination || !state.entrances) {\n      return; // Nothing to do yet\n    }\n    let targets = [] as Array<ElementWithCoordinates>;\n\n    // Try to find the destination among the entrances\n    state.entrances.forEach((entrance) => {\n      if (!state.destination) return; // XXX: Typescript needs this\n      if (\n        state.destination.type === entrance.type &&\n        state.destination.id === entrance.id\n      ) {\n        targets = [entrance];\n      }\n    });\n\n    // If the destination entrance wasn't found, route to all entrances\n    if (!targets.length) {\n      targets = state.entrances;\n    }\n\n    // Clear previous routing results by setting an empty result set\n    setState(\n      (prevState): State => ({\n        ...prevState,\n        route: geometryToGeoJSON(),\n      })\n    );\n\n    // Don't calculate routes between points more than 200 meters apart\n    if (\n      distance(state.origin, destinationToLatLng(state.destination)) >\n      maxRoutingDistance\n    ) {\n      const message = state.isOriginExplicit\n        ? \"Distance too long!\"\n        : \"Routing starts when distance is shorter\";\n      const snackbar = enqueueSnackbar(message, {\n        variant: \"warning\",\n        persist: true,\n        anchorOrigin: {\n          vertical: \"bottom\",\n          horizontal: \"center\",\n        },\n        action: (\n          <>\n            {state.isOriginExplicit && (\n              <Button\n                onClick={(): void => {\n                  setState(\n                    (prevState): State => ({\n                      ...prevState,\n                      origin: prevState.geolocationPosition || undefined,\n                      isOriginExplicit: false,\n                      viewport: fitMap(prevState.viewport, [\n                        prevState.destination &&\n                          destinationToLatLng(prevState.destination),\n                      ]),\n                    })\n                  );\n                }}\n              >\n                Discard origin\n              </Button>\n            )}\n            <Button\n              onClick={(): void => {\n                setState(\n                  (prevState): State => ({\n                    ...prevState,\n                    destination: undefined,\n                    viewport: fitMap(prevState.viewport, [prevState.origin]),\n                  })\n                );\n              }}\n            >\n              Discard destination\n            </Button>\n            <Button\n              target=\"_blank\"\n              rel=\"noreferrer\"\n              href={`https://www.google.com/maps/dir/?api=1&origin=${state.origin[0]},${state.origin[1]}&destination=${state.destination.lat},${state.destination.lon}`}\n            >\n              Google Maps\n            </Button>\n\n            <IconButton\n              aria-label=\"close\"\n              onClick={(): void => closeSnackbar(snackbar)}\n            >\n              <CloseIcon />\n            </IconButton>\n          </>\n        ),\n      });\n      setState((prevState): State => ({ ...prevState, snackbar }));\n      return;\n    }\n\n    calculatePlan(state.origin, targets, (geojson) => {\n      setState(\n        (prevState): State => {\n          // don't use the result if the parameters changed meanwhile\n          if (\n            state.origin !== prevState.origin ||\n            state.entrances !== prevState.entrances ||\n            state.destination !== prevState.destination\n          ) {\n            return prevState;\n          }\n          const extendedGeojson = {\n            ...geojson,\n            features: geojson.features.concat(prevState.route.features),\n          };\n          return {\n            ...prevState,\n            route: extendedGeojson,\n          };\n        }\n      );\n    }).catch((error) => {\n      // eslint-disable-next-line no-console\n      console.error(\"Error while starting route planning:\", error);\n    });\n  }, [state.origin, state.entrances]); // eslint-disable-line react-hooks/exhaustive-deps\n  // XXX: state.destination is missing above as we need to wait for state.entrances to change as well\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const handleMapClick = (event: any): void => {\n    // Inspect the topmost feature under click\n    const feature = map.current?.getMap().queryRenderedFeatures(event.point)[0];\n    setState(\n      (prevState): State => {\n        if (feature?.properties.entrance) {\n          // If an entrance was clicked\n          const element = {\n            id: feature.properties[\"@id\"],\n            type: feature.properties[\"@type\"],\n            lat: feature.geometry.coordinates[1],\n            lon: feature.geometry.coordinates[0],\n            tags: feature.properties,\n          };\n          if (\n            prevState.origin &&\n            distance(prevState.origin, [\n              feature.geometry.coordinates[1],\n              feature.geometry.coordinates[0],\n            ]) < maxRoutingDistance\n          ) {\n            // If the entrance is close enough for routing, set it as destination\n            return {\n              ...prevState,\n              destination: element,\n              popupCoordinates: element,\n              highlights: {\n                type: \"FeatureCollection\",\n                features: [],\n              },\n            };\n          }\n          // Otherwise, just open the popup\n          return {\n            ...prevState,\n            popupCoordinates: element,\n          };\n        }\n        if (feature?.sourceLayer === \"building\") {\n          // If a building was clicked, highlight it and set as destination\n          return {\n            ...prevState,\n            highlights: feature.toJSON(),\n            destination: latLngToDestination([\n              event.lngLat.lat,\n              event.lngLat.lng,\n            ]),\n          };\n        }\n        // As a fallback, toggle popup.\n        if (prevState.popupCoordinates) {\n          return {\n            ...prevState,\n            popupCoordinates: null,\n          };\n        }\n        return {\n          ...prevState,\n          popupCoordinates: latLngToDestination([\n            event.lngLat.lat,\n            event.lngLat.lng,\n          ]),\n          highlights: {\n            type: \"FeatureCollection\",\n            features: [],\n          },\n        };\n      }\n    );\n  };\n\n  /**\n   * Two tasks:\n   * - update geolocation position into state\n   * - change origin if deemed appropriate\n   */\n  const onGeolocate = (position: Position): void =>\n    setState(\n      (prevState): State => {\n        if (prevState.isGeolocating) {\n          const isFirstPosition = prevState.geolocationPosition == null;\n          const geolocationPosition: LatLng = [\n            position.coords.latitude,\n            position.coords.longitude,\n          ];\n          const viewport =\n            isFirstPosition && !prevState.isOriginExplicit\n              ? fitMap(prevState.viewport, [\n                  geolocationPosition,\n                  prevState.destination &&\n                    destinationToLatLng(prevState.destination),\n                ])\n              : prevState.viewport;\n          const updateBase = { ...prevState, geolocationPosition, viewport };\n          if (\n            !prevState.isOriginExplicit &&\n            (prevState.origin == null ||\n              distance(prevState.origin, geolocationPosition) > 20)\n          ) {\n            return { ...updateBase, origin: geolocationPosition };\n          }\n          return updateBase;\n        }\n        return prevState;\n      }\n    );\n\n  return (\n    <div data-testid=\"app\" className=\"App\">\n      <header className=\"App-header\">\n        <h2>Gatesolve</h2>\n      </header>\n      <div className=\"App-shadow\" />\n      <ReactAutosuggestGeocoder\n        ref={geocoder}\n        url=\"https://api.digitransit.fi/geocoding/v1\"\n        sources=\"oa,osm,nlsfi\"\n        highlightFirstSuggestion\n        inputProps={{ placeholder: \"Destination name or address\" }}\n        center={{\n          latitude:\n            state.geolocationPosition?.[0] ||\n            state.origin?.[0] ||\n            state.destination?.lat ||\n            metropolitanAreaCenter[0],\n          longitude:\n            state.geolocationPosition?.[1] ||\n            state.origin?.[1] ||\n            state.destination?.lon ||\n            metropolitanAreaCenter[1],\n        }}\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        onSuggestionSelected={(event: any, { suggestion }: any): any => {\n          const destination: LatLng = [\n            suggestion.geometry.coordinates[1],\n            suggestion.geometry.coordinates[0],\n          ];\n          const [type, id] = suggestion.properties.source_id.split(\":\");\n          setState(\n            (prevState): State => {\n              const pointsToFit =\n                prevState.origin &&\n                distance(prevState.origin, destination) < maxRoutingDistance\n                  ? [prevState.origin, destination]\n                  : [destination];\n              const viewport = fitMap(prevState.viewport, pointsToFit);\n              return {\n                ...prevState,\n                origin: prevState.origin,\n                destination: {\n                  lat: destination[0],\n                  lon: destination[1],\n                  type,\n                  id: Number(id),\n                },\n                entrances: [],\n                viewport: { ...prevState.viewport, ...viewport },\n              };\n            }\n          );\n        }}\n      />\n      <MapGL\n        ref={map}\n        // This is according to the Get Started materials:\n        // https://uber.github.io/react-map-gl/docs/get-started/get-started/\n        // eslint-disable-next-line react/jsx-props-no-spreading\n        {...state.viewport}\n        style={{ width: \"100%\", height: \"90%\" }}\n        mapStyle=\"https://raw.githubusercontent.com/HSLdevcom/hsl-map-style/master/simple-style.json\"\n        transformRequest={transformRequest}\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        onViewportChange={(viewport: any): void => {\n          setState((prevState): State => ({ ...prevState, viewport }));\n        }}\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        onHover={(event: any): void => {\n          // Inspect the topmost feature under click\n          const feature = event.features?.[0];\n          // Set cursor shape depending whether we would click an entrance\n          const cursor = feature?.properties.entrance ? \"pointer\" : \"grab\";\n          // FIXME: Better way to set the pointer shape or at least find the element\n          const mapboxOverlaysElement = document.querySelector(\n            \".overlays\"\n          ) as HTMLElement;\n          if (mapboxOverlaysElement) {\n            mapboxOverlaysElement.style.cursor = cursor;\n          }\n        }}\n        onClick={handleMapClick}\n        onContextmenu={handleMapClick}\n      >\n        <GeolocateControl\n          dataTestId=\"geolocate-control\"\n          enableOnMount\n          onEnable={(isInitiatedByUser): void => {\n            setState((prevState) => ({\n              ...prevState,\n              isOriginExplicit:\n                !isInitiatedByUser && prevState.isOriginExplicit,\n              isGeolocating: true,\n            }));\n          }}\n          onDisable={(): void => {\n            setState((prevState) => ({\n              ...prevState,\n              isGeolocating: false,\n              geolocationPosition: null,\n            }));\n          }}\n          onGeolocate={onGeolocate}\n        />\n        {state.geolocationPosition != null && (\n          <Marker\n            offset={[-20, -20]}\n            longitude={state.geolocationPosition[1]}\n            latitude={state.geolocationPosition[0]}\n          >\n            <UserPosition dataTestId=\"user-marker\" />\n          </Marker>\n        )}\n        {Array.from(\n          state.routableTiles.entries(),\n          ([coords, tile]) =>\n            tile && (\n              <Source\n                key={coords}\n                id={`source-${coords}`}\n                type=\"geojson\"\n                data={tile}\n              >\n                {allEntrancesLayers.map((layer) => (\n                  <Layer\n                    // eslint-disable-next-line react/jsx-props-no-spreading\n                    {...layer}\n                    key={`${layer.id}-${coords}`}\n                    id={`${layer.id}-${coords}`}\n                    source={`source-${coords}`}\n                  />\n                ))}\n              </Source>\n            )\n        )}\n        <Source id=\"highlights\" type=\"geojson\" data={state.highlights}>\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...buildingHighlightLayer}\n            source=\"highlights\"\n          />\n        </Source>\n\n        <Source id=\"route\" type=\"geojson\" data={state.route}>\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routeLineLayer}\n            source=\"route\"\n          />\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routeImaginaryLineLayer}\n            source=\"route\"\n          />\n\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routePointLayer}\n            source=\"route\"\n          />\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routePointSymbolLayer}\n            source=\"route\"\n          />\n        </Source>\n        {state.origin && (\n          <Marker\n            className=\"PinMarker\"\n            draggable\n            offset={[0, -22.5]}\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            onDragEnd={(lngLat: any): void => {\n              setState(\n                (prevState): State => ({\n                  ...prevState,\n                  origin: [lngLat.lat, lngLat.lng],\n                  isOriginExplicit: true,\n                })\n              );\n            }}\n            longitude={state.origin[1]}\n            latitude={state.origin[0]}\n          >\n            <Pin\n              dataTestId=\"origin\"\n              style={{ fill: \"#00afff\", stroke: \"#fff\" }}\n            />\n          </Marker>\n        )}\n        {state.destination && (\n          <Marker\n            className=\"PinMarker\"\n            draggable\n            offset={[0, -22.5]}\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            onDragEnd={(lngLat: any): void => {\n              geocoder.current.clear();\n              setState(\n                (prevState): State => ({\n                  ...prevState,\n                  destination: latLngToDestination([lngLat.lat, lngLat.lng]),\n                })\n              );\n            }}\n            longitude={state.destination.lon}\n            latitude={state.destination.lat}\n          >\n            <Pin\n              dataTestId=\"destination\"\n              style={{\n                fill: \"#64be14\",\n                stroke: \"#fff\",\n              }}\n            />\n          </Marker>\n        )}\n        <Popup\n          open={state.popupCoordinates != null}\n          latitude={state.popupCoordinates?.lat || null}\n          longitude={state.popupCoordinates?.lon || null}\n          closeButton={false}\n          closeOnClick={false}\n        >\n          {state.popupCoordinates && (\n            <>\n              <div>\n                <h3>\n                  {state.popupCoordinates.tags?.[\"addr:street\"]}{\" \"}\n                  {state.popupCoordinates.tags?.[\"addr:housenumber\"]}{\" \"}\n                  {state.popupCoordinates.tags?.[\"ref\"] ||\n                    state.popupCoordinates.tags?.[\"addr:unit\"]}\n                </h3>\n                <p>\n                  {state.popupCoordinates.tags && (\n                    <table\n                      style={{\n                        textAlign: \"left\",\n                      }}\n                    >\n                      <tbody>\n                        {Object.entries(state.popupCoordinates.tags)\n                          .filter(\n                            ([k]) =>\n                              !k.startsWith(\"@\") &&\n                              ![\n                                \"addr:street\",\n                                \"addr:housenumber\",\n                                \"addr:unit\",\n                                \"ref\",\n                              ].includes(k)\n                          )\n                          .map(([k, v]) => (\n                            <tr key={`${k}-${v}`}>\n                              <td\n                                style={{\n                                  padding: \"0 5px 0 0\",\n                                }}\n                              >\n                                {k}\n                              </td>\n                              <td>{v}</td>\n                            </tr>\n                          ))}\n                      </tbody>\n                    </table>\n                  )}\n                </p>\n              </div>\n              <Button\n                data-testid=\"origin-button\"\n                variant=\"contained\"\n                size=\"small\"\n                style={{ backgroundColor: \"#00afff\", color: \"#fff\" }}\n                type=\"button\"\n                aria-label=\"Set origin\"\n                onClick={(): void =>\n                  setState(\n                    (prevState): State => {\n                      // Check this to appease the compiler.\n                      if (prevState.popupCoordinates != null) {\n                        return {\n                          ...prevState,\n                          origin: destinationToLatLng(\n                            prevState.popupCoordinates\n                          ),\n                          isOriginExplicit: true,\n                          popupCoordinates: null,\n                        };\n                      }\n                      return {\n                        ...prevState,\n                        isOriginExplicit: true,\n                        popupCoordinates: null,\n                      };\n                    }\n                  )\n                }\n              >\n                Origin\n              </Button>\n              <span style={{ padding: \"5px\" }} />\n              <Button\n                data-testid=\"destination-button\"\n                variant=\"contained\"\n                size=\"small\"\n                style={{ backgroundColor: \"#64be14\", color: \"#fff\" }}\n                type=\"button\"\n                aria-label=\"Set destination\"\n                onClick={(): void =>\n                  setState(\n                    (prevState): State => {\n                      // Check this to appease the compiler.\n                      if (prevState.popupCoordinates != null) {\n                        return {\n                          ...prevState,\n                          destination: prevState.popupCoordinates,\n                          popupCoordinates: null,\n                        };\n                      }\n                      return {\n                        ...prevState,\n                        popupCoordinates: null,\n                      };\n                    }\n                  )\n                }\n              >\n                Destination\n              </Button>\n            </>\n          )}\n        </Popup>\n      </MapGL>\n    </div>\n  );\n};\n\nexport default App;\n"],"sourceRoot":""}