{"version":3,"sources":["map-style.ts","mapbox-style-typescript.ts","components/Pin.tsx","components/Triangle.tsx","olmap.ts","components/OLMapDialog.tsx","components/OLMapImages.tsx","components/UserPosition.tsx","components/GeolocateControl.tsx","routable-tiles.ts","planner.ts","overpass.ts","mapbox-utils.ts","RoutableTilesToGeoJSON.js","minimal-xyz-viewer.js","App.tsx"],"names":["houseLabelMaybeSpace","maybeSpace","hidden","notHidden","literal","val","has","key","get","getVar","toBoolean","expression","not","length","gt","expression1","expression2","any","expressions","all","coalesce","format","parts","flatMap","cond","cases","routeLineLayers","id","type","layout","paint","filter","routeImaginaryLineLayer","routePointLayer","buildingHighlightLayer","zoomDependentEntranceLabel","concat","labelName","midZoomLabel","caseEntranceLabel","missing","visible","ifEntranceLabelVisibleElse","invisible","allEntrancesLayers","minzoom","maxzoom","anchors","angle","index","anglesToAnchors","routePointSymbolLayer","SVG_VIEWBOX","SVG_PATH","pinAsSVG","size","style","Pin","height","fill","stroke","dataTestId","data-testid","viewBox","pointerEvents","d","cursor","gradientTransform","offset","stopColor","stopOpacity","TRIANGLE_PATH","dotPath","radius","triangleDotAsSVG","dotSize","dotStyle","triangleAsSVG","olmapNoteURL","noteId","fetchOlmapData","osmId","a","undefined","fetch","response","json","data","state","code","status","OLMapDialog","onClose","Dialog","open","fullWidth","PaperProps","overflow","DialogTitle","IconButton","position","top","right","onClick","Close","borderTop","title","src","border","padding","margin","width","OLMapImages","onImageClick","olmapData","content","image_notes","note","image","slice","map","href","target","rel","display","maxWidth","maxHeight","alt","className","UserPosition","strokeWidth","cx","cy","r","GeolocateControl","onGeolocate","onGeolocateError","positionOptions","enableHighAccuracy","timeout","onEnable","onDisable","enableOnMount","useState","window","navigator","geolocation","isGeolocationSupported","permissions","isPermissionsSupported","permissionState","setPermissionState","watchID","setWatchId","hasBeenUsed","setHasBeenUsed","startWatching","isInitiatedByUser","watchPosition","stopWatching","clearWatch","showWarningOfDeniedGeolocation","console","log","useEffect","query","name","then","permissionStatus","onchange","this","catch","error","isClickingAllowed","isGeolocationOn","element","ariaLabel","buttonClassName","aria-label","aria-pressed","onContextMenu","event","preventDefault","assert","aria-hidden","NAMESPACE_REGEX","triplesToTags","subject","defined","freeform","tags","Object","entries","forEach","property","object","startsWith","replace","value","toLowerCase","tag","splitIndex","indexOf","substring","extractGeometry","path","coordinates","obstacles","obstacleWays","Map","imaginaryWays","legs","getSteps","step","startLocation","stopLocation","node","context","through","definedTags","wayContext","freeformTags","set","push","longitude","latitude","lon","lat","Array","from","values","geometryToGeoJSON","origin","targets","entrances","routeGeometries","features","geometry","properties","entrance","obstacle","calculatePlan","callback","Planner","planner","setProfileID","process","to","take","on","completePath","geoJSON","buildMatchingStreetQuery","street","streetEscaped","queryMatchingStreet","url","URL","searchParams","append","toString","body","elements","way","getMapSize","mapboxgl","getContainer","clientWidth","clientHeight","processBuildingEntrances","buildingEntrances","some","includes","processWay","nodes","isInnerRole","relation","nodeIds","isWayClockwise","wayEntrances","nodeId","turfBooleanClockwise","turfLineString","xy","xyPrev","xyNext","bearingPrev","turfBearing","bearingNext","entranceAngle","Math","abs","min","adaptedAngle","entranceLabel","houseLabel","label","entranceNodeToLabel","cos","PI","sin","house","find","ref","unit","ways","relations","i","lngLat","relationEntrances","member","role","processRelations","processWays","TILE_SIZE","DIAMETER","WEBMERCATOR_R","getVisibleTiles","center","zoom","centerm","lonlat","x","sinlat","y","mercatorProject","centerpx","pow","bbox","floor","ceil","tiles","px","py","latLngToDestination","latLng","destinationToLatLng","destination","initialState","route","highlights","viewport","bearing","pitch","isOriginExplicit","isGeolocating","geolocationPosition","popupCoordinates","routableTiles","metropolitanAreaCenter","transformRequest","originalURL","distance","turfDistance","units","parseLatLng","text","split","Number","isNaN","fitBounds","viewportOptions","latLngs","WebMercatorViewport","inputs","minLng","maxLng","max","minLat","maxLat","bottom","left","maxZoom","App","useRef","geocoder","current","getMap","iconId","renderSVG","shape","svgData","imageId","ratio","devicePixelRatio","canvas","document","createElement","ctx","getContext","img","Image","svgDataUrl","encodeURIComponent","onload","Error","drawImage","addImage","getImageData","pixelRatio","addImageSVG","urlMatch","useRouteMatch","setState","fitMap","mapWidth","mapHeight","zoomMultiplier","tilesetZoomLevel","visibleTiles","prevState","routableTilesToGeoJSON","newRoutableTiles","params","history","useHistory","snackbarFunctions","useSnackbar","enqueueSnackbar","closeSnackbar","location","pathname","newLocation","exec","search","utmSource","URLSearchParams","newSearch","utm_source","queryEntrances","result","snackbar","streetName","streetGeometry","point","turfNearestPointOnLine","message","variant","persist","anchorOrigin","vertical","horizontal","action","Button","color","geojson","extendedGeojson","handleMapClick","feature","queryRenderedFeatures","noHighlights","clickCoordinates","lng","reverse","parseInt","barrier","highway","toArray","sourceLayer","toJSON","getOlmapId","setEditingNote","editingNote","sources","highlightFirstSuggestion","inputProps","placeholder","onSuggestionSelected","suggestion","setTimeout","blur","source_id","pointsToFit","mapStyle","dragRotate","onViewportChange","onHover","mapboxOverlaysElement","querySelector","onContextmenu","isFirstPosition","coords","updateBase","tile","layer","source","before","draggable","onDragEnd","clear","closeButton","closeOnClick","gridTemplateColumns","fontSize","fontWeight","textAlign","getOlmapUrl","AddComment","backgroundColor","marginTop","marginBottom","k","v","justifyContent"],"mappings":"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","file":"static/js/App.5e317f44.chunk.js","sourcesContent":["import type { LayerProps } from \"react-map-gl\"; // eslint-disable-line import/no-extraneous-dependencies\nimport type { Expression } from \"mapbox-gl\";\nimport {\n  literal,\n  has,\n  get,\n  getVar,\n  toBoolean,\n  not,\n  length,\n  gt,\n  any,\n  all,\n  concat,\n  coalesce,\n  format,\n  cond,\n} from \"./mapbox-style-typescript\";\n\nconst anglesToAnchors = (): Array<string | number> => {\n  const offset = 0;\n  const angles = [22.5, 67.5, 112.5, 157.5, 202.5, 247.7, 292.5, 337.5];\n\n  const anchors = [\n    \"top\",\n    \"top-right\",\n    \"right\",\n    \"bottom-right\",\n    \"bottom\",\n    \"bottom-left\",\n    \"left\",\n    \"top-left\",\n  ];\n\n  const initialStep: Array<string | number> = [anchors[offset]];\n  const ret = initialStep.concat(\n    angles.flatMap((angle, index) => {\n      return [angle, anchors[(offset + index + 1) % anchors.length]] as Array<\n        string | number\n      >;\n    })\n  );\n\n  return ret;\n};\n\nconst routeLineLayer: LayerProps = {\n  id: \"route-line\",\n  type: \"line\",\n  layout: {\n    \"line-cap\": \"round\",\n    \"line-join\": \"round\",\n  },\n  paint: {\n    \"line-opacity\": [\"coalesce\", [\"get\", \"@opacity\"], 0.8],\n    \"line-width\": 2,\n    \"line-color\": [\"get\", \"@color\"],\n  },\n  filter: [\"!\", [\"coalesce\", [\"get\", \"@imaginary\"], false]],\n};\n\nconst routeLineInteractive: LayerProps = {\n  id: \"route-line-interactive\",\n  type: \"line\",\n  paint: {\n    \"line-width\": 16,\n    \"line-opacity\": 0,\n  },\n  filter: [\"coalesce\", [\"get\", \"@interactive\"]],\n};\n\nexport const routeLineLayers: Array<LayerProps> = [\n  routeLineLayer,\n  routeLineInteractive,\n];\n\nexport const routeImaginaryLineLayer: LayerProps = {\n  id: \"route-imaginary-line\",\n  type: \"line\",\n  layout: {\n    \"line-cap\": \"round\",\n    \"line-join\": \"round\",\n  },\n  paint: {\n    \"line-opacity\": [\"coalesce\", [\"get\", \"@opacity\"], 0.5],\n    \"line-width\": 5,\n    \"line-color\": [\"get\", \"@color\"],\n    \"line-dasharray\": [0, 2],\n  },\n  filter: [\"coalesce\", [\"get\", \"@imaginary\"], false],\n};\n\nexport const routePointLayer: LayerProps = {\n  id: \"route-point\",\n  type: \"circle\",\n  paint: {\n    \"circle-opacity\": [\"coalesce\", [\"get\", \"@opacity\"], 1],\n    \"circle-radius\": 5,\n    \"circle-color\": [\"get\", \"@color\"],\n  },\n  filter: [\"==\", \"Point\", [\"geometry-type\"]],\n};\n\nexport const buildingHighlightLayer: LayerProps = {\n  id: \"building-highlight\",\n  type: \"fill\",\n  paint: {\n    \"fill-opacity\": 0.3,\n    \"fill-color\": \"#99ff99\",\n  },\n};\n\nconst entrancePoints: LayerProps = {\n  id: \"entrance-point\",\n  type: \"circle\",\n  minzoom: 12,\n  maxzoom: 16,\n  paint: {\n    \"circle-radius\": [\n      \"interpolate\",\n      [\"linear\"],\n      [\"zoom\"],\n      12, // At zoom 12 or less,\n      1, // circle radius is 1.\n      14, // At zoom 14,\n      2, // circle radius is 2.\n      15, // At zoom 15 or more,\n      3, // circle radius is 3.\n    ],\n    \"circle-color\": \"#64be14\",\n  },\n};\n\nconst lowZoomLabel = (maybeSpace: Expression): Expression =>\n  format(\n    [\n      cond(\n        [not(toBoolean(get(\"@house-label\"))), \"\"], // No housenumber\n        [\n          any(\n            coalesce(get(\"@secondary\"), false),\n            gt(length(get(\"@house-label\")), 3)\n          ),\n          \"路\",\n        ], // Hide housenumber.\n        [get(\"@house-label\")] // Full housenumber\n      ),\n      {},\n    ],\n    [maybeSpace, {}],\n    // Last, the entrance letter, in bold font\n    [\n      cond(\n        [not(toBoolean(get(\"@entrance-label\"))), \"\"], // No housenumber\n        [all(coalesce(get(\"@secondary\"), false)), \"路\"], // Hide letter.\n        [get(\"@entrance-label\")] // Full entrance letter\n      ),\n      {\n        \"text-font\": [\"literal\", [\"Klokantech Noto Sans Bold\"]],\n      },\n    ]\n  );\n\nconst hasNoLabel = (labelName: string): Expression =>\n  not(toBoolean(get(labelName)));\n\nconst midZoomLabel = (maybeSpace: Expression): Expression =>\n  format(\n    [\n      cond(\n        [hasNoLabel(\"@house-label\"), \"\"], // No housenumber\n        [\n          any(\n            coalesce(get(\"@secondary\"), false),\n            gt(length(get(\"@house-label\")), 3)\n          ),\n          \"路\",\n        ], // Hide housenumber.\n        [get(\"@house-label\")] // Full housenumber\n      ),\n      {},\n    ],\n    [maybeSpace, {}],\n    // Last, the entrance letter, in bold font\n    [\n      cond(\n        [not(toBoolean(get(\"@entrance-label\"))), \"\"], // No housenumber\n        [\n          all(\n            coalesce(get(\"@secondary\"), false),\n            gt(length(get(\"@entrance-label\")), 1)\n          ),\n          \"路\",\n        ], // Hide letter.\n        [get(\"@entrance-label\")] // Full entrance letter\n      ),\n      {\n        \"text-font\": [\"literal\", [\"Klokantech Noto Sans Bold\"]],\n      },\n    ]\n  );\n\n// always show the housenumber followed by the bolded entrance letter\nconst highZoomLabel = (houseLabelMaybeSpace: Expression): Expression =>\n  format(\n    // First, the housenumber, without special formatting\n    [houseLabelMaybeSpace, {}],\n    // Last, the entrance letter, in bold font\n    [\n      get(\"@entrance-label\"),\n      {\n        \"text-font\": [\"literal\", [\"Klokantech Noto Sans Bold\"]],\n      },\n    ]\n  );\n\nconst zoomDependentEntranceLabel: Expression = [\n  \"let\",\n  \"maybe_space\",\n  cond(\n    // If we have both labels, then separate by a thin space.\n    [all(has(\"@house-label\"), has(\"@entrance-label\")), \"\\u2009\"],\n    [\"\"] // Otherwise, no separator.\n  ),\n  \"house_label_maybe_space\",\n  concat(\n    get(\"@house-label\"),\n    cond(\n      // If we have both labels, then separate by a thin space.\n      [all(has(\"@house-label\"), has(\"@entrance-label\")), \"\\u2009\"],\n      [\"\"] // Otherwise, no separator.\n    )\n  ),\n  [\n    \"step\",\n    [\"zoom\"],\n    lowZoomLabel(getVar(\"maybe_space\")),\n    17, // At zoom 17 or more,\n    midZoomLabel(getVar(\"maybe_space\")),\n    18, // At zoom 18 or more,\n    highZoomLabel(getVar(\"house_label_maybe_space\")),\n  ],\n];\n\nconst caseEntranceLabel = ({\n  missing,\n  visible,\n  hidden,\n}: {\n  missing: Expression;\n  visible: Expression;\n  hidden: Expression;\n}): Expression => [\n  \"step\",\n  [\"zoom\"],\n  // lowZoomLabel\n  cond(\n    [\n      not(\n        any(toBoolean(get(\"@house-label\")), toBoolean(get(\"@entrance-label\")))\n      ),\n      missing,\n    ],\n    [\n      all(\n        not(\n          // housenumber visible\n          all(\n            toBoolean(get(\"@house-label\")),\n            not(toBoolean(get(\"@secondary\"))),\n            not(gt(length(get(\"@house-label\")), 3))\n          )\n        ),\n        not(\n          // entrance label visible\n          all(\n            toBoolean(get(\"@entrance-label\")),\n            not(toBoolean(get(\"@secondary\")))\n          )\n        )\n      ),\n      hidden,\n    ],\n    [visible]\n  ),\n  17, // At zoom 17 or more,\n  // midZoomLabel\n  cond(\n    [\n      not(\n        any(toBoolean(get(\"@house-label\")), toBoolean(get(\"@entrance-label\")))\n      ),\n      missing,\n    ],\n    [\n      all(\n        not(\n          // housenumber visible\n          all(\n            toBoolean(get(\"@house-label\")),\n            not(toBoolean(get(\"@secondary\"))),\n            not(gt(length(get(\"@house-label\")), 3))\n          )\n        ),\n        not(\n          // entrance label visible\n          all(\n            toBoolean(get(\"@entrance-label\")),\n            any(\n              not(toBoolean(get(\"@secondary\"))),\n              not(gt(length(get(\"@entrance-label\")), 1))\n            )\n          )\n        )\n      ),\n      hidden,\n    ],\n    [visible]\n  ),\n  18, // At zoom 18 or more,\n  // highZoomLabel\n  cond(\n    [\n      not(\n        any(toBoolean(get(\"@house-label\")), toBoolean(get(\"@entrance-label\")))\n      ),\n      missing,\n    ],\n    [visible]\n  ),\n];\n\nconst ifEntranceLabelHiddenElse = (\n  hidden: Expression,\n  notHidden: Expression\n): Expression =>\n  caseEntranceLabel({\n    missing: notHidden,\n    visible: notHidden,\n    hidden,\n  });\n\nconst ifEntranceLabelVisibleElse = (\n  visible: Expression,\n  invisible: Expression\n): Expression =>\n  caseEntranceLabel({\n    missing: invisible,\n    visible,\n    hidden: invisible,\n  });\n\nconst entranceSymbols: LayerProps = {\n  id: \"entrance-symbol\",\n  type: \"symbol\",\n  minzoom: 16,\n  paint: {\n    \"text-halo-color\": \"#fff\",\n    \"text-color\": \"#64be14\",\n    \"text-halo-width\": 1,\n    \"icon-opacity\": ifEntranceLabelVisibleElse(literal(1), literal(0.5)),\n    \"text-opacity\": ifEntranceLabelVisibleElse(literal(1), literal(0)),\n  },\n  layout: {\n    \"text-field\": zoomDependentEntranceLabel,\n    \"text-font\": [\"Klokantech Noto Sans Regular\"],\n    \"text-size\": 16,\n    \"text-offset\": [\"get\", \"@offset\"],\n    \"text-anchor\": [\"step\", [\"%\", [\"get\", \"@rotate\"], 360]].concat(\n      anglesToAnchors()\n    ) as Expression,\n    \"text-rotation-alignment\": \"map\",\n    \"text-allow-overlap\": true,\n    \"text-ignore-placement\": true,\n    \"icon-image\": ifEntranceLabelHiddenElse(\n      literal(\"icon-svg-triangleDot-28-#64be14-#fff\"),\n      literal(\"icon-svg-triangle-28-#64be14-#fff\")\n    ),\n    \"icon-anchor\": \"center\",\n    \"icon-rotate\": [\"get\", \"@rotate\"],\n    \"icon-rotation-alignment\": \"map\",\n    \"icon-allow-overlap\": true,\n    \"icon-ignore-placement\": true,\n  },\n};\n\nexport const allEntrancesLayers: Array<LayerProps> = [\n  entrancePoints, // smaller zoom levels\n  entranceSymbols, // larger zoom levels\n];\n\nexport const routePointSymbolLayer: LayerProps = {\n  id: \"route-point-symbol\",\n  type: \"symbol\",\n  paint: {\n    \"text-color\": \"#000\",\n    \"text-halo-color\": \"#fff\",\n    \"text-halo-width\": 3,\n  },\n  layout: {\n    \"text-field\": [\"get\", \"@label\"],\n    \"text-anchor\": \"center\",\n    \"text-font\": [\"Klokantech Noto Sans Regular\"],\n    \"text-size\": 24,\n    \"text-offset\": [0, -0.05],\n  },\n  filter: [\"==\", \"Point\", [\"geometry-type\"]],\n};\n","import type { Expression } from \"mapbox-gl\";\n\nexport const literal = <T>(val: T): Expression => [\"literal\", val];\nexport const has = (key: string): Expression => [\"has\", key];\nexport const get = (key: string): Expression => [\"get\", key];\nexport const getVar = (key: string): Expression => [\"var\", key];\nexport const toBoolean = (expression: Expression): Expression => [\n  \"to-boolean\",\n  expression,\n];\nexport const not = (expression: Expression): Expression => [\"!\", expression];\nexport const length = (expression: Expression): Expression => [\n  \"length\",\n  expression,\n];\nexport const gt = (\n  expression1: Expression,\n  expression2: Expression | number\n): Expression => [\">\", expression1, expression2];\nexport const any = (...expressions: Array<Expression>): Expression => [\n  \"any\",\n  ...expressions,\n];\nexport const all = (...expressions: Array<Expression>): Expression => [\n  \"all\",\n  ...expressions,\n];\nexport const concat = (...expressions: Array<Expression>): Expression => [\n  \"concat\",\n  ...expressions,\n];\nexport const coalesce = <T>(\n  ...expressions: Array<Expression | T>\n): Expression => [\"coalesce\", ...expressions];\nexport const format = (\n  ...parts: Array<[Expression | string, Record<string, unknown>]>\n): Expression => [\n  \"format\",\n  ...parts.flatMap(([...textAndStyle]) => textAndStyle),\n];\n// Scheme-style conditional: cond([condition, value]..., [defaultValue])\nexport const cond = <T>(\n  ...cases: Array<[Expression, Expression | T] | [Expression | T]>\n): Expression => {\n  return [\"case\", ...cases.flatMap(([...testAndBody]) => testAndBody)];\n};\n","import React from \"react\";\n\nexport interface PinProps {\n  height?: string;\n  style?: React.CSSProperties;\n  dataTestId?: string;\n}\n\nconst SVG_VIEWBOX = \"-1 -1 17 17\";\nconst SVG_PATH =\n  \"M7.5 0C5.068 0 2.23 1.486 2.23 5.27c0 2.568 4.054 8.244 5.27 9.73c1.081-1.486 5.27-7.027 5.27-9.73C12.77 1.487 9.932 0 7.5 0z\";\n\nexport const pinAsSVG = (size: number, style: string): string => `\n<svg xmlns=\"http://www.w3.org/2000/svg\"\n  width=\"${size}px\"\n  height=\"${size}px\"\n  style=\"${style}\"\n  viewBox=\"${SVG_VIEWBOX}\"\n>\n  <path d=\"${SVG_PATH}\" />\n</svg>`;\n\nconst Pin: React.FC<PinProps> = ({\n  height = \"50\",\n  style = { fill: \"#444\", stroke: \"none\" },\n  dataTestId,\n}) => {\n  return (\n    <svg\n      data-testid={dataTestId}\n      height={height}\n      style={style}\n      viewBox={SVG_VIEWBOX}\n      pointerEvents=\"none\"\n    >\n      <path\n        fill={`url(#gradient-${style.fill})`}\n        d={SVG_PATH}\n        pointerEvents=\"visiblepainted\"\n        cursor=\"pointer\"\n      />\n      <defs>\n        <linearGradient\n          id={`gradient-${style.fill}`}\n          gradientTransform=\"rotate(90)\"\n        >\n          <stop offset=\"00%\" stopColor=\"#FFFFFF\" stopOpacity=\"0\" />\n          <stop offset=\"100%\" stopColor={style.fill} stopOpacity=\"1\" />\n        </linearGradient>\n      </defs>\n    </svg>\n  );\n};\n\nexport default Pin;\n","const SVG_VIEWBOX = \"-5 -1 25 50\";\nconst TRIANGLE_PATH = \"M 8 16 L 0 8 L 16 8 Z\";\nconst dotPath = (radius: number) => `\nM ${8 - radius} ${32 + radius}\na ${radius} ${radius}, 0, 0, 0, ${2 * radius} 0\na ${radius} ${radius}, 0, 0, 0, ${-2 * radius} 0\n`;\n\n// eslint-disable-next-line import/prefer-default-export\nexport const triangleDotAsSVG = (\n  size: number,\n  style: string,\n  dotSize = 3,\n  dotStyle = \"stroke-width: 1\"\n): string => `\n<svg xmlns=\"http://www.w3.org/2000/svg\"\n  width=\"${size}px\"\n  height=\"${size}px\"\n  style=\"${style}\"\n  viewBox=\"${SVG_VIEWBOX}\"\n>\n  <path d=\"${TRIANGLE_PATH}\" />\n  <path style=\"${dotStyle}\" d=\"${(dotSize && dotPath(dotSize)) || \"\"}\" />\n</svg>`;\n\nexport const triangleAsSVG = (size: number, style: string): string =>\n  triangleDotAsSVG(size, style, 0);\n","import type { ElementWithCoordinates } from \"./overpass\";\n\nexport type NetworkLoadingState = {\n  state: \"loading\";\n};\n\nexport type NetworkFailedState = {\n  state: \"failed\";\n  code: number;\n};\n\nexport type NetworkSuccessState<T> = {\n  state: \"success\";\n  response: T;\n};\n\nexport type NetworkState<T> =\n  | NetworkLoadingState\n  | NetworkFailedState\n  | NetworkSuccessState<T>;\n\nexport interface OlmapResponse {\n  associated_entrances: Array<number>;\n  image_notes: Array<OlmapNote>;\n  detail?: string;\n  status: number;\n}\n\nexport interface OlmapNote {\n  id: number;\n  image: string;\n}\n\nexport const olmapNoteURL = (noteId: number): string =>\n  `https://app.olmap.org/#/note/${noteId}`;\n\nexport const olmapNewNoteURL = (target: ElementWithCoordinates): string => {\n  if (target.id === -1) {\n    return `https://app.olmap.org/#/Notes/new/photo/@${target.lat},${target.lon}`;\n  }\n  return `https://app.olmap.org/#/Notes/new/${target.id}/photo/@${target.lat},${target.lon}`;\n};\n\nexport const fetchOlmapData = async (\n  osmId: number\n): Promise<NetworkState<OlmapResponse> | undefined> => {\n  if (osmId === -1) {\n    return undefined;\n  }\n  try {\n    const response = await fetch(\n      `https://api.olmap.org/rest/osm_features/${osmId}/`\n    );\n    try {\n      const data = await response.json();\n      return {\n        state: \"success\",\n        response: data as OlmapResponse,\n      };\n    } catch {\n      return {\n        state: \"failed\",\n        code: response.status,\n      };\n    }\n  } catch {\n    return {\n      state: \"failed\",\n      code: 0,\n    };\n  }\n};\n","import React from \"react\";\nimport { IconButton, Dialog, DialogTitle } from \"@material-ui/core\";\nimport { Close as CloseIcon } from \"@material-ui/icons\";\n\nimport { olmapNoteURL } from \"../olmap\";\n\ninterface OLMapDialogProps {\n  noteId?: number;\n  onClose: () => void;\n}\n\nconst OLMapDialog: React.FC<OLMapDialogProps> = ({ noteId, onClose }) => (\n  <Dialog\n    open={!!noteId}\n    fullWidth\n    PaperProps={{ style: { height: \"100%\", overflow: \"hidden\" } }}\n  >\n    {noteId && (\n      <>\n        <DialogTitle>\n          Note on OLMap\n          <IconButton\n            style={{\n              position: \"absolute\",\n              top: \"8px\",\n              right: \"8px\",\n            }}\n            onClick={onClose}\n          >\n            <CloseIcon />\n          </IconButton>\n        </DialogTitle>\n        <div\n          style={{\n            height: \"100%\",\n            borderTop: \"1px solid rgba(0, 0, 0, 0.12)\",\n          }}\n        >\n          <iframe\n            title=\"OLMap note editor\"\n            src={olmapNoteURL(noteId)}\n            style={{\n              border: \"none\",\n              padding: 0,\n              margin: 0,\n              width: \"100%\",\n              height: \"100%\",\n            }}\n          />\n        </div>\n      </>\n    )}\n  </Dialog>\n);\nexport default OLMapDialog;\n","import React from \"react\";\n\nimport { olmapNoteURL, NetworkState, OlmapResponse } from \"../olmap\";\n\ninterface OLMapImagesProps {\n  onImageClick: (event: React.MouseEvent<HTMLElement>) => void;\n  olmapData?: NetworkState<OlmapResponse>;\n}\n\nconst OLMapImages: React.FC<OLMapImagesProps> = ({\n  onImageClick,\n  olmapData,\n}) => {\n  const content =\n    olmapData?.state === \"success\" &&\n    olmapData?.response?.image_notes\n      ?.filter((note) => note.image)\n      .slice(0, 1) // take 1\n      .map((note) => (\n        <a\n          key={note.id}\n          href={olmapNoteURL(note.id)}\n          onClick={onImageClick}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          style={{ display: \"inline-flex\" }}\n        >\n          {/* eslint-disable-next-line jsx-a11y/img-redundant-alt */}\n          <img\n            style={{ maxWidth: \"100%\", maxHeight: \"150px\" }}\n            src={note.image}\n            alt=\"A photo of the entrance\"\n          />\n        </a>\n      ));\n  return <div className=\"olmapImages\">{content}</div>;\n};\n\nexport default OLMapImages;\n","import React from \"react\";\n\nexport interface UserPositionProps {\n  dataTestId?: string;\n  width?: string;\n  height?: string;\n  stroke?: string;\n  strokeWidth?: string;\n}\n\nconst UserPosition: React.FC<UserPositionProps> = ({\n  dataTestId,\n  width = \"40\",\n  height = \"40\",\n  stroke = \"#00afff\",\n  strokeWidth = \"16\",\n}) => (\n  <svg\n    data-testid={dataTestId}\n    width={width}\n    height={height}\n    stroke={stroke}\n    strokeWidth={strokeWidth}\n    viewBox=\"-100 -100 200 200\"\n    fill=\"transparent\"\n    style={{ position: \"absolute\" }}\n  >\n    <circle cx=\"0\" cy=\"0\" r=\"24\" />\n    <circle cx=\"0\" cy=\"0\" r=\"46\" />\n    <circle cx=\"0\" cy=\"0\" r=\"68\" />\n  </svg>\n);\n\nexport default UserPosition;\n","import React, { useState, useEffect } from \"react\";\nimport type { MouseEventHandler } from \"react\";\n\nexport interface GeolocateControlProps {\n  dataTestId?: string;\n  onGeolocate: PositionCallback;\n  onGeolocateError?: PositionErrorCallback;\n  positionOptions?: PositionOptions;\n  onEnable?: (isInitiatedByUser: boolean) => void;\n  onDisable?: () => void;\n  enableOnMount?: boolean;\n}\n\nconst GeolocateControl: React.FC<GeolocateControlProps> = ({\n  dataTestId,\n  onGeolocate,\n  onGeolocateError,\n  positionOptions = { enableHighAccuracy: true, timeout: 6000 },\n  onEnable,\n  onDisable,\n  enableOnMount = true,\n}) => {\n  const [isGeolocationSupported] = useState(\n    window.navigator.geolocation != null\n  );\n  const [isPermissionsSupported] = useState(\n    window.navigator.permissions != null\n  );\n  const [permissionState, setPermissionState] = useState(\n    null as PermissionState | null\n  );\n  const [watchID, setWatchId] = useState(null as number | null);\n  const [hasBeenUsed, setHasBeenUsed] = useState(false);\n\n  const checkGeolocationPermission = (): void => {\n    if (isPermissionsSupported) {\n      window.navigator.permissions\n        .query({ name: \"geolocation\" })\n        .then((permissionStatus) => {\n          setPermissionState(permissionStatus.state);\n          function setPermissionStateOnChange(this: PermissionStatus): void {\n            setPermissionState(this.state);\n          }\n          // eslint-disable-next-line no-param-reassign\n          permissionStatus.onchange = setPermissionStateOnChange;\n        })\n        .catch((error) => {\n          // FIXME: Warn properly\n          // eslint-disable-next-line no-console\n          console.error(\"Permissions API exists but querying it fails:\", error);\n        });\n    }\n  };\n\n  const startWatching = (isInitiatedByUser: boolean): void => {\n    if (isGeolocationSupported && watchID == null) {\n      setWatchId(\n        window.navigator.geolocation.watchPosition(\n          onGeolocate,\n          onGeolocateError,\n          positionOptions\n        )\n      );\n      setHasBeenUsed(true);\n      if (onEnable != null) {\n        onEnable(isInitiatedByUser);\n      }\n    }\n  };\n\n  const stopWatching = (): void => {\n    if (isGeolocationSupported && watchID != null) {\n      /**\n       * Based on reading the Geolocation API spec (\n       * https://www.w3.org/TR/2016/REC-geolocation-API-20161108/#geolocation_interface\n       * ) and trying out in practice on Chromium, one can call clearWatch\n       * regardless of permissions.\n       */\n      window.navigator.geolocation.clearWatch(watchID);\n      setWatchId(null);\n      if (onDisable != null) {\n        onDisable();\n      }\n    }\n  };\n\n  const showWarningOfDeniedGeolocation = (): void => {\n    // FIXME: Inform the user that geolocation is denied.\n    // eslint-disable-next-line no-console\n    console.log(\"Geolocation is denied. Inform the user.\");\n  };\n\n  // Inform the user once if geolocation is not supported.\n  useEffect(() => {\n    if (!isGeolocationSupported) {\n      // FIXME: Warn the user\n      // eslint-disable-next-line no-console\n      console.log(\"Geolocation is not supported. Inform the user.\");\n    }\n  }, [isGeolocationSupported]);\n\n  // Figure out the permissionState.\n  useEffect(() => {\n    if (\n      isGeolocationSupported &&\n      isPermissionsSupported &&\n      permissionState == null\n    ) {\n      checkGeolocationPermission();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Warn the user about denied permission.\n  useEffect(() => {\n    if (permissionState === \"denied\") {\n      showWarningOfDeniedGeolocation();\n      stopWatching();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [permissionState]);\n\n  /**\n   * If Permissions API is supported, only allow clicking once the\n   * PermissionState is known.\n   */\n  const isClickingAllowed = !isPermissionsSupported || permissionState != null;\n  const isGeolocationOn = watchID != null;\n\n  // Start watching on mount if asked.\n  useEffect(() => {\n    if (\n      enableOnMount &&\n      !hasBeenUsed &&\n      isGeolocationSupported &&\n      !isGeolocationOn &&\n      (!isPermissionsSupported ||\n        (permissionState != null && permissionState !== \"denied\"))\n    ) {\n      startWatching(false);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    enableOnMount,\n    hasBeenUsed,\n    isGeolocationSupported,\n    isGeolocationOn,\n    isPermissionsSupported,\n    permissionState,\n  ]);\n\n  const onClick: MouseEventHandler = (event) => {\n    /**\n     * Assume that Geolocation API exists.\n     *\n     * Assume either permissionState is known or the Permissios API is not\n     * supported.\n     */\n    // FIXME: Maybe find a way so this does not need to be remembered.\n    // eslint-disable-next-line no-console\n    console.assert(isGeolocationSupported);\n    // FIXME: Maybe find a way so this does not need to be remembered.\n    // FIXME: Remove these debug asserts\n    // eslint-disable-next-line no-console\n    console.assert(isClickingAllowed);\n    event.preventDefault();\n\n    if (!isGeolocationOn) {\n      if (isPermissionsSupported && permissionState === \"denied\") {\n        // Warn the user again if they press the button.\n        showWarningOfDeniedGeolocation();\n      } else {\n        startWatching(true);\n      }\n    } else {\n      stopWatching();\n    }\n  };\n\n  let element = null;\n  if (isGeolocationSupported) {\n    const ariaLabel = isGeolocationOn\n      ? \"Stop using my location\"\n      : \"Find my location\";\n    const buttonClassName = isGeolocationOn\n      ? \"mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate mapboxgl-ctrl-geolocate-active\"\n      : \"mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate\";\n    element = (\n      <div className=\"mapboxgl-ctrl mapboxgl-ctrl-group mapboxgl-ctrl-bottom-left\">\n        <button\n          type=\"button\"\n          className={buttonClassName}\n          data-testid={dataTestId}\n          aria-label={ariaLabel}\n          aria-pressed={isGeolocationOn}\n          onContextMenu={(event): void => event.preventDefault()}\n          onClick={isClickingAllowed ? onClick : undefined}\n        >\n          <span className=\"mapboxgl-ctrl-icon\" aria-hidden=\"true\" />\n        </button>\n      </div>\n    );\n  }\n  return element;\n};\n\nexport default GeolocateControl;\n","export const NAMESPACE_URI = \"https://w3id.org/openstreetmap/terms#\";\nconst NAMESPACE_REGEX = /^(https:\\/\\/w3id.org\\/openstreetmap\\/terms#|osm:)/;\n\nexport const triplesToTags = (\n  subject: string,\n  defined?: Record<string, string>,\n  freeform?: Array<string>\n): Record<string, string> => {\n  const tags = { \"@id\": subject } as Record<string, string>;\n\n  // Undo the mapping by openplannerteam/routable-tiles-ontology\n  Object.entries(defined || {}).forEach(([property, object]) => {\n    if (!property.startsWith(NAMESPACE_URI) && !property.startsWith(\"osm:\"))\n      return;\n    if (\n      property === \"https://w3id.org/openstreetmap/terms#hasTag\" ||\n      property === \"osm:hasTag\"\n    )\n      return;\n    const key = property.replace(NAMESPACE_REGEX, \"\");\n    const value = object.replace(NAMESPACE_REGEX, \"\");\n    // Special-case mappings: (XXX: should handle smoothness, oneway, osm:Dirt, some highway values ...)\n    if (value === \"NoAccess\") {\n      tags[key] = \"no\";\n    } else if (value === \"FreeAccess\") {\n      tags[key] = \"yes\";\n    } else if (value === \"OfficialAccess\") {\n      tags[key] = \"official\";\n    } else if (key === \"highway\" && value === \"UnderConstruction\") {\n      tags[key] = \"construction\";\n    } else if (key === \"construction\" && value === \"UnderConstruction\") {\n      tags[key] = \"yes\";\n    } else {\n      // Convert from Routable Tiles's CamelCase to OSM's lower_case\n      tags[key] = value.replace(/([a-z])([A-Z])/g, \"$1_$2\").toLowerCase();\n    }\n  });\n\n  // Split osm:hasTag \"key=value\" into key => value\n  freeform?.forEach((tag) => {\n    const splitIndex = tag.indexOf(\"=\");\n    const key = tag.substring(0, splitIndex);\n    const value = tag.substring(splitIndex + 1);\n    tags[key] = value;\n  });\n  return tags;\n};\n","import type {\n  Feature,\n  FeatureCollection,\n  Geometry,\n  GeoJsonProperties,\n} from \"geojson\"; // eslint-disable-line import/no-extraneous-dependencies\n\nimport { triplesToTags } from \"./routable-tiles\";\n\n// \"./planner-config\" (and PlannerJS) is imported dynamically by calculatePlan\n\nimport { ElementWithCoordinates, Tags } from \"./overpass\";\n\ninterface RouteGeometries {\n  coordinates: Array<[number, number]>;\n  obstacles: Array<ElementWithCoordinates>;\n  obstacleWays: Array<[Tags, Array<[number, number]>]>;\n  imaginaryWays: Array<Array<[number, number]>>;\n}\n\nfunction extractGeometry(\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  path: any\n): RouteGeometries {\n  const coordinates = [] as Array<[number, number]>;\n  const obstacles = [] as Array<ElementWithCoordinates>;\n  const obstacleWays = new Map<string, [Tags, Array<[number, number]>]>();\n  const imaginaryWays = [] as Array<Array<[number, number]>>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  path.legs[0].getSteps().forEach((step: any, index: number) => {\n    /* XXX: Would be nice to get a null step.through from PlannerJS here.\n       Heuristic below: PlannerJS connects the origin and destination to\n       the nearest OSM ways through a node which does not have an id,\n       so the steps whose geometry is not based on an OSM way have\n       nodes without ids at both ends. Additionally, the second step is a\n       false positive if origin and destination connect to same OSM edge.\n     */\n    if (!step.startLocation.id && !step.stopLocation.id && index !== 1) {\n      imaginaryWays.push([\n        [\n          step.startLocation.longitude as number,\n          step.startLocation.latitude as number,\n        ],\n        [\n          step.stopLocation.longitude as number,\n          step.stopLocation.latitude as number,\n        ],\n      ]);\n      return; // guessed segment\n    }\n    const node = step.stopLocation;\n    if (\n      path.context[step.through]?.definedTags[\n        \"https://w3id.org/openstreetmap/terms#highway\"\n      ] === \"https://w3id.org/openstreetmap/terms#Steps\"\n    ) {\n      if (!obstacleWays.has(step.through)) {\n        const wayContext = path.context[step.through];\n        const tags = triplesToTags(\n          step.through,\n          wayContext.definedTags,\n          wayContext.freeformTags\n        );\n        obstacleWays.set(step.through, [tags, []]);\n      }\n      obstacleWays\n        .get(step.through)?.[1]\n        .push(\n          [\n            step.startLocation.longitude as number,\n            step.startLocation.latitude as number,\n          ],\n          [\n            step.stopLocation.longitude as number,\n            step.stopLocation.latitude as number,\n          ]\n        );\n    }\n    if (node.definedTags?.[\"https://w3id.org/openstreetmap/terms#barrier\"]) {\n      const tags = triplesToTags(node.id, node.definedTags, node.freeformTags);\n      obstacles.push({\n        type: node.id,\n        id: node.id,\n        lon: node.longitude as number,\n        lat: node.latitude as number,\n        tags,\n      });\n    }\n    coordinates.push([\n      step.startLocation.longitude as number,\n      step.startLocation.latitude as number,\n    ]);\n    coordinates.push([\n      step.stopLocation.longitude as number,\n      step.stopLocation.latitude as number,\n    ]);\n  });\n  return {\n    coordinates,\n    obstacles,\n    obstacleWays: Array.from(obstacleWays.values()),\n    imaginaryWays,\n  };\n}\n\nexport function geometryToGeoJSON(\n  origin?: [number, number],\n  targets?: Array<ElementWithCoordinates>,\n  entrances?: Array<ElementWithCoordinates>,\n  routeGeometries?: RouteGeometries\n): FeatureCollection {\n  const features = [] as Array<Feature<Geometry, GeoJsonProperties>>;\n  if (origin) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"Point\",\n        coordinates: [origin[1], origin[0]],\n      },\n      properties: {\n        \"@color\": \"#00afff\",\n      },\n    });\n  }\n  if (targets) {\n    targets.forEach((target) => {\n      features.push({\n        type: \"Feature\",\n        geometry: {\n          type: \"Point\",\n          coordinates: [target.lon, target.lat],\n        },\n        properties: {\n          \"@color\": \"#64be14\",\n        },\n      });\n    });\n  }\n  if (entrances) {\n    entrances.forEach((entrance) => {\n      features.push({\n        type: \"Feature\",\n        geometry: {\n          type: \"Point\",\n          coordinates: [entrance.lon, entrance.lat],\n        },\n        properties: {\n          \"@color\": \"#00ffff\",\n          \"@label\": entrance.tags?.[\"ref\"] || entrance.tags?.[\"addr:unit\"],\n          \"@opacity\": 0,\n        },\n      });\n    });\n  }\n  if (routeGeometries?.coordinates) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"LineString\",\n        coordinates: routeGeometries.coordinates,\n      },\n      properties: {\n        \"@color\": \"#000\",\n      },\n    });\n  }\n  routeGeometries?.obstacleWays.forEach(([tags, geometry]) => {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"LineString\",\n        coordinates: geometry,\n      },\n      properties: {\n        ...tags,\n        \"@color\": \"#dc0451\",\n        \"@opacity\": 1,\n        \"@interactive\": true,\n      },\n    });\n  });\n  if (routeGeometries?.imaginaryWays) {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"MultiLineString\",\n        coordinates: routeGeometries.imaginaryWays,\n      },\n      properties: {\n        \"@color\": \"#000\",\n        \"@imaginary\": true,\n      },\n    });\n  }\n  routeGeometries?.obstacles.forEach((obstacle) => {\n    features.push({\n      type: \"Feature\",\n      geometry: {\n        type: \"Point\",\n        coordinates: [obstacle.lon, obstacle.lat],\n      },\n      properties: {\n        ...obstacle.tags,\n        \"@color\": \"#dc0451\",\n        \"@label\": \"!\",\n      },\n    });\n  });\n  return {\n    type: \"FeatureCollection\",\n    features,\n  };\n}\n\nexport default async function calculatePlan(\n  origin: [number, number],\n  targets: Array<ElementWithCoordinates>,\n  callback: (f: FeatureCollection) => void\n): Promise<void> {\n  const { Planner } = await import(\n    /* webpackChunkName: \"planner-config\" */\n    /* webpackPrefetch: true */\n    \"./planner-config\"\n  );\n  targets.forEach((target) => {\n    const planner = new Planner();\n    // XXX setProfileID requires URL to start with scheme, so guess\n    const protocol = process.env.NODE_ENV === \"production\" ? \"https\" : \"http\";\n    planner\n      .setProfileID(`${protocol}://${process.env.PUBLIC_URL}/delivery.json`)\n      .query({\n        from: { latitude: origin[0], longitude: origin[1] },\n        to: { latitude: target.lat, longitude: target.lon },\n      })\n      .take(1)\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      .on(\"data\", async (path: any) => {\n        const completePath = await planner.completePath(path);\n        // eslint-disable-next-line no-console\n        console.log(\"Plan\", completePath, \"from\", origin, \"to\", target);\n        const routeGeometries = extractGeometry(completePath);\n        const geoJSON = geometryToGeoJSON(\n          origin,\n          [target],\n          undefined,\n          routeGeometries\n        );\n        callback(geoJSON);\n      });\n  });\n}\n","import type { MultiLineString } from \"geojson\";\n\nexport interface OverpassResponse {\n  version: number;\n  generator: string;\n  osm3s: Osm3S;\n  elements: Element[];\n}\n\nexport interface Osm3S {\n  timestamp_osm_base: Date;\n  copyright: string;\n}\n\nexport type Element =\n  | ElementWithCoordinates\n  | ElementWithGeometry\n  | (ElementCore & Partial<Coordinates>);\n\nexport type ElementWithCoordinates = ElementCore & Coordinates;\n\nexport type ElementWithGeometry = ElementCore & {\n  geometry: Array<Coordinates>;\n};\n\ninterface ElementCore {\n  type: string;\n  id: number;\n  tags?: Tags;\n}\n\nexport interface Coordinates {\n  lat: number;\n  lon: number;\n}\n\nexport interface Tags {\n  entrance?: string;\n  operator?: string;\n  ref?: string;\n  \"addr:unit\"?: string;\n  \"addr:housenumber\"?: string;\n  \"addr:street\"?: string;\n}\n\nconst buildEntranceQuery = (lat: number, lon: number): string => `\n  [out:json][timeout:25];\n  (\n    relation(around:10, ${lat}, ${lon})[building];\n    way(r);\n    way(around:10, ${lat}, ${lon})[building];\n  )->.b;\n  (\n    relation(around.b:10)[\"building:part\"];\n    way(r);\n    way(around.b:10)[\"building:part\"];\n  )->.p;\n  // gather results\n  (\n    node(w.b)[entrance];\n    node(w.p)[entrance];\n  );\n  // print results\n  out body;\n  >;\n  out skel qt;\n`;\n\nexport const queryEntrances = (\n  target: ElementWithCoordinates\n): Promise<ElementWithCoordinates[]> => {\n  const url = new URL(\"https://overpass.fvh.io/api/interpreter\");\n  url.searchParams.append(\"data\", buildEntranceQuery(target.lat, target.lon));\n  return fetch(url.toString()).then((response) =>\n    response.json().then((body: OverpassResponse) => {\n      const targets = body.elements.filter(\n        (element) =>\n          element.type === \"node\" &&\n          \"lat\" in element &&\n          element.lat != null &&\n          \"lon\" in element &&\n          element.lon != null &&\n          element.tags &&\n          element.tags.entrance\n      );\n      // FIXME: How to make the compiler deduce this by itself from above?\n      // For example, see https://github.com/Microsoft/TypeScript/issues/16069\n      return targets as ElementWithCoordinates[];\n    })\n  );\n};\n\nconst buildMatchingStreetQuery = (\n  lat: number,\n  lon: number,\n  street: string\n): string => {\n  const streetEscaped = street\n    .replace(/\\\\/g, \"\\\\\\\\\")\n    .replace(/\"/g, '\\\\\"')\n    .replace(/\\n/g, \"\\\\n\");\n  return `\n  [out:json][timeout:25];\n  (\n    way(around:100, ${lat}, ${lon})[\"highway\"][name=\"${streetEscaped}\"];\n  );\n  // print results as id and geometry for each way in qt (non-sorted) order\n  out ids geom qt;`;\n};\n\nexport const queryMatchingStreet = async (\n  target: ElementWithCoordinates,\n  street: string\n): Promise<MultiLineString> => {\n  const url = new URL(\"https://overpass.rwqr.org/api/interpreter\");\n  url.searchParams.append(\n    \"data\",\n    buildMatchingStreetQuery(target.lat, target.lon, street)\n  );\n  const response = await fetch(url.toString());\n  const body = await response.json();\n  const coordinates = body.elements.map((way: ElementWithGeometry) =>\n    way.geometry.map(({ lat, lon }) => [lon, lat])\n  );\n  return {\n    type: \"MultiLineString\",\n    coordinates,\n  };\n};\n","import { Map } from \"mapbox-gl\";\n\n// eslint-disable-next-line import/prefer-default-export\nexport const addImageSVG = (\n  mapboxgl: Map,\n  imageId: string,\n  svgData: string,\n  size: number\n): void => {\n  const ratio = window.devicePixelRatio;\n\n  const canvas = document.createElement(\"canvas\");\n  canvas.width = ratio * size;\n  canvas.height = ratio * size;\n\n  const ctx = canvas.getContext(\"2d\");\n  const img = new Image(size, size);\n\n  const svgDataUrl = `data:image/svg+xml,${encodeURIComponent(svgData)}`;\n\n  img.onload = (): void => {\n    if (!ctx) {\n      throw Error(\"canvas.getContext failed\");\n    }\n\n    ctx.drawImage(img, 0, 0, ratio * size, ratio * size);\n    mapboxgl.addImage(\n      imageId,\n      ctx.getImageData(0, 0, ratio * size, ratio * size),\n      { pixelRatio: ratio }\n    );\n  };\n\n  img.src = svgDataUrl;\n};\n\nexport const getMapSize = (\n  mapboxgl: Map\n): { width: number; height: number } => ({\n  width: mapboxgl?.getContainer()?.clientWidth,\n  height: mapboxgl?.getContainer()?.clientHeight,\n});\n","// Original source: https://github.com/openplannerteam/leaflet-routable-tiles/blob/master/lib/RoutableTilesToGeoJSON.js\n\nimport {\n  bearing as turfBearing,\n  lineString as turfLineString,\n  booleanClockwise as turfBooleanClockwise,\n} from \"@turf/turf\";\n\nimport { triplesToTags } from \"./routable-tiles\";\n\nconst offset = 0.2;\n\nvar processRelations = function (relations, ways, nodes, entrances) {\n  Object.values(relations)\n    .filter((relation) => {\n      return relation[\"osm:hasTag\"]?.find(\n        (tag) => tag.startsWith(\"building=\") || tag.startsWith(\"building:part=\")\n      );\n    })\n    .forEach((relation) => {\n      const relationEntrances = relation[\"osm:hasMembers\"].flatMap((member) => {\n        // Process the member way if it's included in the tile\n        const way = ways[member[\"@id\"]];\n        if (way) {\n          return processWay(\n            way,\n            nodes,\n            entrances,\n            member.role === \"inner\",\n            relation\n          );\n        }\n        return [];\n      });\n      processBuildingEntrances(relationEntrances);\n    });\n};\n\nvar processWays = function (ways, nodes, entrances) {\n  Object.values(ways)\n    .filter((way) => {\n      return way[\"osm:hasTag\"]?.find(\n        (tag) => tag.startsWith(\"building=\") || tag.startsWith(\"building:part=\")\n      );\n    })\n    .forEach((way) => {\n      processBuildingEntrances(processWay(way, nodes, entrances));\n    });\n};\n\nvar processBuildingEntrances = function (buildingEntrances) {\n  // If the building has a staircase or a main entrance,\n  // mark other entrances as secondary\n  if (\n    buildingEntrances.some((entrance) =>\n      [\"staircase\", \"main\"].includes(entrance.properties[\"entrance\"])\n    )\n  ) {\n    buildingEntrances.forEach((entrance) => {\n      if (![\"staircase\", \"main\"].includes(entrance.properties[\"entrance\"])) {\n        entrance.properties[\"@secondary\"] = true;\n      }\n    });\n  }\n};\n\nvar processWay = function (way, nodes, entrances, isInnerRole, relation) {\n  if (!way[\"osm:hasNodes\"]) {\n    return []; // no nodes to process\n  } else if (typeof way[\"osm:hasNodes\"] === \"string\") {\n    return []; // a single node cannot be processed as a way\n  }\n\n  const nodeIds = way[\"osm:hasNodes\"];\n  if (nodeIds.length < 4) {\n    console.log(\"not an area\", way[\"@id\"]);\n    return [];\n  }\n  if (nodeIds[0] !== nodeIds[nodeIds.length - 1]) {\n    console.log(\"unclosed\", way[\"@id\"]);\n  }\n  let isWayClockwise = null;\n  let wayEntrances = [];\n  nodeIds.forEach((nodeId, index, nodeIds) => {\n    const entrance = entrances[nodeId];\n    if (entrance) {\n      // Calculate clockwiseness only when first entrance is hit\n      if (isWayClockwise === null) {\n        isWayClockwise = turfBooleanClockwise(\n          turfLineString(nodeIds.map((id) => nodes[id]))\n        );\n      }\n      const xy = nodes[nodeId];\n      const xyPrev =\n        index === 0\n          ? nodes[nodeIds[nodeIds.length - 2]]\n          : nodes[nodeIds[index - 1]];\n      const xyNext =\n        index === nodeIds.length - 1\n          ? nodes[nodeIds[1]]\n          : nodes[nodeIds[index + 1]];\n\n      const bearingPrev = turfBearing(xy, xyPrev);\n      const bearingNext = turfBearing(xy, xyNext);\n      const entranceAngle =\n        Math.abs(bearingPrev - bearingNext) / 2 +\n        Math.min(bearingPrev, bearingNext);\n      const adaptedAngle =\n        bearingPrev > bearingNext ? entranceAngle + 270 : entranceAngle + 90;\n      const angle =\n        isWayClockwise !== !!isInnerRole ? adaptedAngle : adaptedAngle + 180;\n\n      let entranceLabel = entrance.properties[\"@entrance-label\"];\n      let houseLabel = entrance.properties[\"@house-label\"];\n      // Inherit information from the building, but only\n      // if there is no building information at the entrance\n      // XXX: Inherit from building as well if this way is a building part\n      if (!entrance.properties[\"addr:housenumber\"]) {\n        if (!entrance.properties[\"ref\"] && !entrance.properties[\"addr:unit\"]) {\n          const label = entranceNodeToLabel(relation || way); // XXX: merge?\n          entranceLabel = entranceLabel || label.entrance;\n          // XXX: Inherit street and housenumber only if they are not ambiguous\n          // houseLabel = label.house;\n        }\n      }\n\n      entrance.properties = {\n        ...entrance.properties,\n        \"@offset\": [\n          Math.cos((angle / 180) * Math.PI) * offset,\n          Math.sin((angle / 180) * Math.PI) * offset,\n        ],\n        \"@rotate\": (((angle - 90) % 360) + 360) % 360,\n        \"@entrance-label\": entranceLabel,\n        \"@house-label\": houseLabel,\n      };\n      wayEntrances.push(entrance);\n    }\n  });\n  return wayEntrances;\n};\n\nconst entranceNodeToLabel = function (node) {\n  const house =\n    node[\"osm:hasTag\"]\n      ?.find((tag) => tag.startsWith(\"addr:housenumber=\"))\n      ?.substring(17) || \"\";\n  const ref = node[\"osm:hasTag\"]\n    ?.find((tag) => tag.startsWith(\"ref=\"))\n    ?.substring(4);\n  const unit = node[\"osm:hasTag\"]\n    ?.find((tag) => tag.startsWith(\"addr:unit=\"))\n    ?.substring(10);\n  const entrance = ref || unit || \"\";\n  return {\n    house: house.replace(/ /g, \"\\u2009\"),\n    entrance: entrance.replace(/ /g, \"\\u2009\"),\n  };\n};\n\nexport default function (json) {\n  var entrances = {};\n  var nodes = {};\n  var ways = {};\n  var relations = {};\n  for (var i = 0; i < json[\"@graph\"].length; i++) {\n    let element = json[\"@graph\"][i];\n    if (element[\"@type\"] === \"osm:Relation\") {\n      relations[element[\"@id\"]] = element;\n    } else if (element[\"@type\"] === \"osm:Way\") {\n      ways[element[\"@id\"]] = element;\n    } else if (element[\"geo:lat\"] && element[\"geo:long\"]) {\n      // Store the coordinates of every node for later reference\n      const lngLat = [element[\"geo:long\"], element[\"geo:lat\"]];\n      nodes[element[\"@id\"]] = lngLat;\n\n      if (element[\"osm:hasTag\"]?.find((tag) => tag.startsWith(\"entrance=\"))) {\n        // Create a GeoJSON feature for each entrance\n\n        const id = element[\"@id\"];\n        // XXX: Could be computed later on demand\n        const tags = triplesToTags(id, element, element[\"osm:hasTag\"]);\n\n        const entranceLabel = entranceNodeToLabel(element);\n        const entrance = {\n          type: \"Feature\",\n          geometry: {\n            type: \"Point\",\n            coordinates: lngLat,\n          },\n          properties: {\n            ...tags,\n            \"@entrance-label\": entranceLabel.entrance,\n            \"@house-label\": entranceLabel.house,\n          },\n        };\n\n        entrances[id] = entrance;\n      }\n    }\n  }\n  processRelations(relations, ways, nodes, entrances);\n  processWays(ways, nodes, entrances);\n  return {\n    type: \"FeatureCollection\",\n    features: Object.values(entrances),\n  };\n}\n","// Source: https://gist.github.com/jsanz/e8549c7bffd442235a942695ffdaf77d\n\nconst TILE_SIZE = 256;\nconst WEBMERCATOR_R = 6378137.0;\nconst DIAMETER = WEBMERCATOR_R * 2 * Math.PI;\n\nexport function mercatorProject(lonlat) {\n  var x = (DIAMETER * lonlat[0]) / 360.0;\n  var sinlat = Math.sin((lonlat[1] * Math.PI) / 180.0);\n  var y = (DIAMETER * Math.log((1 + sinlat) / (1 - sinlat))) / (4 * Math.PI);\n  return [DIAMETER / 2 + x, DIAMETER - (DIAMETER / 2 + y)];\n}\n// console.log(Mercator.project([-3,41]))\n\nexport function getVisibleTiles(clientWidth, clientHeight, center, zoom) {\n  var centerm = mercatorProject(center);\n  // zoom + centerm -> centerpx\n  var centerpx = [\n    (centerm[0] * TILE_SIZE * Math.pow(2, zoom)) / DIAMETER,\n    (centerm[1] * TILE_SIZE * Math.pow(2, zoom)) / DIAMETER,\n  ];\n\n  // xmin, ymin, xmax, ymax\n  var bbox = [\n    Math.floor((centerpx[0] - clientWidth / 2) / TILE_SIZE),\n    Math.floor((centerpx[1] - clientHeight / 2) / TILE_SIZE),\n    Math.ceil((centerpx[0] + clientWidth / 2) / TILE_SIZE),\n    Math.ceil((centerpx[1] + clientHeight / 2) / TILE_SIZE),\n  ];\n  var tiles = [];\n  //xmin, ymin, xmax, ymax\n  for (let x = bbox[0]; x < bbox[2]; ++x) {\n    for (let y = bbox[1]; y < bbox[3]; ++y) {\n      var [px, py] = [\n        x * TILE_SIZE - centerpx[0] + clientWidth / 2,\n        y * TILE_SIZE - centerpx[1] + clientHeight / 2,\n      ];\n      tiles.push({ x, y, zoom, px, py });\n    }\n  }\n  return tiles;\n}\n","import React, { useState, useEffect, useRef, ReactText } from \"react\";\nimport { useRouteMatch, useHistory } from \"react-router-dom\";\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport type { match } from \"react-router-dom\";\nimport { Button, IconButton } from \"@material-ui/core\";\nimport {\n  Close as CloseIcon,\n  AddComment as AddCommentIcon,\n} from \"@material-ui/icons\";\nimport { useSnackbar } from \"notistack\";\nimport MapGL, { Popup, Source, Layer, Marker } from \"@urbica/react-map-gl\";\nimport { WebMercatorViewport } from \"@math.gl/web-mercator\";\nimport type { WebMercatorViewportOptions } from \"@math.gl/web-mercator/dist/es6/web-mercator-viewport\";\nimport {\n  distance as turfDistance,\n  nearestPointOnLine as turfNearestPointOnLine,\n} from \"@turf/turf\";\nimport { MapboxGeoJSONFeature } from \"mapbox-gl\";\nimport \"mapbox-gl/dist/mapbox-gl.css\";\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { FeatureCollection } from \"geojson\";\nimport { ReactAutosuggestGeocoder } from \"react-autosuggest-geocoder\";\n\nimport {\n  routePointLayer,\n  routePointSymbolLayer,\n  routeLineLayers,\n  routeImaginaryLineLayer,\n  buildingHighlightLayer,\n  allEntrancesLayers,\n} from \"./map-style\";\nimport Pin, { pinAsSVG } from \"./components/Pin\";\nimport { triangleAsSVG, triangleDotAsSVG } from \"./components/Triangle\";\nimport OLMapDialog from \"./components/OLMapDialog\";\nimport OLMapImages from \"./components/OLMapImages\";\nimport UserPosition from \"./components/UserPosition\";\nimport GeolocateControl from \"./components/GeolocateControl\";\nimport calculatePlan, { geometryToGeoJSON } from \"./planner\";\nimport {\n  queryEntrances,\n  queryMatchingStreet,\n  ElementWithCoordinates,\n} from \"./overpass\";\nimport { addImageSVG, getMapSize } from \"./mapbox-utils\";\nimport routableTilesToGeoJSON from \"./RoutableTilesToGeoJSON\";\nimport { getVisibleTiles } from \"./minimal-xyz-viewer\";\nimport {\n  fetchOlmapData,\n  olmapNewNoteURL,\n  olmapNoteURL,\n  OlmapResponse,\n  NetworkState,\n} from \"./olmap\";\n\nimport \"./App.css\";\nimport \"./components/PinMarker.css\";\n\nconst maxRoutingDistance = 200; // in meters\n\ntype LatLng = [number, number];\n\ntype ViewportState = Omit<WebMercatorViewportOptions, \"width\" | \"height\">;\n\ninterface State {\n  viewport: ViewportState;\n  isOriginExplicit: boolean;\n  origin?: LatLng;\n  destination?: ElementWithCoordinates;\n  entrances?: Array<ElementWithCoordinates>;\n  route: FeatureCollection;\n  highlights?: MapboxGeoJSONFeature | FeatureCollection;\n  isGeolocating: boolean;\n  geolocationPosition: LatLng | null;\n  popupCoordinates: ElementWithCoordinates | null;\n  snackbar?: ReactText;\n  routableTiles: Map<string, FeatureCollection | null>;\n  olmapData?: NetworkState<OlmapResponse>;\n  editingNote?: number;\n}\n\nconst latLngToDestination = (latLng: LatLng): ElementWithCoordinates => ({\n  id: -1,\n  type: \"node\",\n  lat: latLng[0],\n  lon: latLng[1],\n});\n\nconst destinationToLatLng = (destination: ElementWithCoordinates): LatLng => [\n  destination.lat,\n  destination.lon,\n];\n\nconst initialState: State = {\n  entrances: [],\n  route: geometryToGeoJSON(),\n  highlights: {\n    type: \"FeatureCollection\",\n    features: [],\n  },\n  viewport: {\n    latitude: 60.17,\n    longitude: 24.941,\n    zoom: 15,\n    bearing: 0,\n    pitch: 0,\n  },\n  isOriginExplicit: false,\n  isGeolocating: false,\n  geolocationPosition: null,\n  popupCoordinates: null,\n  routableTiles: new Map(),\n};\n\nconst metropolitanAreaCenter = [60.17066815612902, 24.941510260105133];\n\nconst transformRequest = (originalURL: string): { url: string } => {\n  const url = originalURL.replace(\n    \"https://static.hsldev.com/mapfonts/Klokantech Noto Sans\",\n    \"https://fonts.openmaptiles.org/Klokantech Noto Sans\"\n  );\n  return { url };\n};\n\nconst distance = (from: LatLng, to: LatLng): number =>\n  turfDistance([from[1], from[0]], [to[1], to[0]], { units: \"meters\" });\n\nconst parseLatLng = (text: string | undefined): LatLng | undefined => {\n  if (text) {\n    const parts = text.split(\",\");\n    if (parts.length === 2 && parts[0].length && parts[1].length) {\n      const [lat, lon] = parts.map(Number);\n      if (!Number.isNaN(lat) && lon > -90 && lon < 90) {\n        return [lat, lon];\n      }\n    }\n  }\n  return undefined;\n};\n\nconst fitBounds = (\n  viewportOptions: WebMercatorViewportOptions,\n  latLngs: Array<LatLng | undefined>\n): WebMercatorViewportOptions => {\n  const viewport = new WebMercatorViewport(viewportOptions);\n  const inputs = latLngs.filter((x) => x) as Array<LatLng>;\n  if (!inputs.length) return viewportOptions; // Nothing to do\n  const minLng = Math.min(...inputs.map((x) => x[1]));\n  const maxLng = Math.max(...inputs.map((x) => x[1]));\n  const minLat = Math.min(...inputs.map((x) => x[0]));\n  const maxLat = Math.max(...inputs.map((x) => x[0]));\n  const padding = 20;\n  const markerSize = 50;\n  const occludedTop = 40;\n  const circleRadius = 5;\n  return viewport.fitBounds(\n    [\n      [minLng, minLat],\n      [maxLng, maxLat],\n    ],\n    {\n      padding: {\n        top: padding + occludedTop + markerSize,\n        bottom: padding + circleRadius,\n        left: padding + markerSize / 2,\n        right: padding + markerSize / 2,\n      },\n      maxZoom: 17,\n    }\n  );\n};\n\nconst App: React.FC = () => {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const map = useRef<any>(null);\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const geocoder = useRef<any>(null);\n\n  // Install a callback to dynamically create pin icons that our map styles use\n  useEffect(() => {\n    if (!map.current) {\n      return; // No map yet, so nothing to do\n    }\n    const mapboxgl = map.current.getMap();\n    // FIXME: Unclear why this passed type checking before.\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    mapboxgl?.on(\"styleimagemissing\", ({ id: iconId }: any) => {\n      if (!iconId?.startsWith(\"icon-svg-\")) {\n        return; // We only know how to generate certain svg icons\n      }\n      const [, , shape, size, fill, stroke] = iconId.split(\"-\"); // e.g. icon-pin-48-green-#fff\n      let renderSVG;\n      if (shape === \"pin\") {\n        renderSVG = pinAsSVG;\n      } else if (shape === \"triangle\") {\n        renderSVG = triangleAsSVG;\n      } else if (shape === \"triangleDot\") {\n        renderSVG = triangleDotAsSVG;\n      } else {\n        return; // Unknown shape\n      }\n      const svgData = renderSVG(size, `fill: ${fill}; stroke: ${stroke}`);\n      addImageSVG(mapboxgl, iconId, svgData, size);\n    });\n  }, [map]);\n\n  const urlMatch = useRouteMatch({\n    path: \"/route/:from?/:to?\",\n  }) as match<{ from: string; to: string }>;\n\n  const [state, setState] = useState(initialState);\n\n  const fitMap = (\n    viewportOptions: ViewportState,\n    latLngs: Array<LatLng | undefined>\n  ): WebMercatorViewportOptions => {\n    return fitBounds(\n      { ...viewportOptions, ...getMapSize(map.current?.getMap()) },\n      latLngs\n    );\n  };\n\n  useEffect(() => {\n    if (!map.current || !state.viewport.zoom) {\n      return; // Nothing to do yet\n    }\n    if (state.viewport.zoom < 12) return; // minzoom\n\n    const { width: mapWidth, height: mapHeight } = getMapSize(\n      map.current.getMap()\n    );\n\n    // Calculate multiplier for under- or over-zoom\n    const tilesetZoomLevel = 14;\n    const zoomOffset = 1; // tiles are 512px (double the standard size)\n    const zoomMultiplier =\n      2 ** (tilesetZoomLevel - zoomOffset - state.viewport.zoom);\n\n    const visibleTiles = getVisibleTiles(\n      zoomMultiplier * mapWidth,\n      zoomMultiplier * mapHeight,\n      [state.viewport.longitude, state.viewport.latitude],\n      tilesetZoomLevel\n    );\n\n    // Initialise the new Map with nulls and available tiles from previous\n    const routableTiles = new Map();\n    visibleTiles.forEach(({ zoom, x, y }) => {\n      const key = `${zoom}/${x}/${y}`;\n      routableTiles.set(key, state.routableTiles.get(key) || null);\n    });\n\n    setState(\n      (prevState: State): State => {\n        return {\n          ...prevState,\n          routableTiles,\n        };\n      }\n    );\n\n    visibleTiles.map(async ({ zoom, x, y }) => {\n      const key = `${zoom}/${x}/${y}`;\n      if (routableTiles.get(key) !== null) return; // We already have the tile\n      // Fetch the tile\n      const response = await fetch(\n        `https://tile.olmap.org/building-tiles/${zoom}/${x}/${y}`\n      );\n      const body = await response.json();\n      // Convert the tile to GeoJSON\n      const geoJSON = routableTilesToGeoJSON(body) as FeatureCollection;\n      // Add the tile if still needed based on latest state\n      setState(\n        (prevState: State): State => {\n          if (prevState.routableTiles.get(key) !== null) {\n            return prevState; // This tile is not needed anymore\n          }\n          const newRoutableTiles = new Map(prevState.routableTiles);\n          newRoutableTiles.set(key, geoJSON);\n          return {\n            ...prevState,\n            routableTiles: newRoutableTiles,\n          };\n        }\n      );\n    });\n  }, [map.current, state.viewport]); // eslint-disable-line react-hooks/exhaustive-deps\n  // XXX: state.routableTiles is missing above as we only use it as a cache here\n\n  useEffect(() => {\n    /**\n     * FIXME: urbica/react-map-gl does not expose fitBounds and state does not\n     * include viewport width and height which are required by fitBounds from\n     * @math.gl/web-mercator. This is dirty but seems to work.\n     */\n    if (!map.current) {\n      return; // No map yet, so nothing to do\n    }\n    const { width, height } = getMapSize(map.current.getMap());\n    if (\n      urlMatch &&\n      width != null &&\n      width > 0 &&\n      height != null &&\n      height > 0\n    ) {\n      const origin = parseLatLng(urlMatch.params.from);\n      const destination = parseLatLng(urlMatch.params.to);\n      const viewportOptions = { ...state.viewport, width, height };\n      const viewport = fitBounds(viewportOptions, [origin, destination]);\n      setState(\n        (prevState): State => ({\n          ...prevState,\n          origin,\n          isOriginExplicit: origin != null,\n          destination: destination && latLngToDestination(destination),\n          viewport: { ...prevState.viewport, ...viewport },\n        })\n      );\n    }\n  }, [map]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  const history = useHistory();\n\n  const snackbarFunctions = useSnackbar();\n  // XXX: useSnackbar does not return functions during unit tests\n  const enqueueSnackbar = snackbarFunctions?.enqueueSnackbar;\n  const closeSnackbar = snackbarFunctions?.closeSnackbar;\n\n  useEffect(() => {\n    const destination = state.destination && [\n      state.destination.lat,\n      state.destination.lon,\n    ];\n    const path = `/route/${state.origin}/${destination}/`;\n    if (history.location.pathname !== path) {\n      let newLocation = path;\n      // Keep utm_source if any in the query parameters\n      if (/utm_source=/.exec(history.location.search)) {\n        const params = new URLSearchParams(history.location.search);\n        const utmSource = params.get(\"utm_source\");\n        if (utmSource !== null) {\n          const newSearch = new URLSearchParams({ utm_source: utmSource });\n          newLocation = `${path}?${newSearch}`;\n        }\n      }\n      history.replace(newLocation);\n    }\n  }, [history, state.origin, state.destination]);\n\n  useEffect(() => {\n    if (!state.destination) return; // Nothing to do yet\n    queryEntrances(state.destination)\n      .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error(\"Error while fetching building entrances:\", error);\n        return []; // Proceed as if there was no entrance data\n      })\n      .then((result) => {\n        setState(\n          (prevState): State => {\n            if (!state.destination) return prevState; // XXX Typescript needs this\n            if (prevState.destination !== state.destination) {\n              return prevState;\n            }\n            const entrances = result.length ? result : [state.destination];\n\n            return {\n              ...prevState,\n              entrances,\n            };\n          }\n        );\n      })\n      .catch((error) => {\n        // eslint-disable-next-line no-console\n        console.error(\"Error while handling entrances:\", error);\n      });\n  }, [state.destination]);\n\n  // Set off routing calculation when inputs change; collect results in state.route\n  useEffect(() => {\n    (async () => {\n      if (state.snackbar) closeSnackbar(state.snackbar);\n\n      if (!state.destination || !state.entrances) {\n        return; // Nothing to do yet\n      }\n      let { origin } = state;\n      let targets = [] as Array<ElementWithCoordinates>;\n\n      // Try to find the destination among the entrances\n      state.entrances.forEach((entrance) => {\n        if (!state.destination) return; // XXX: Typescript needs this\n        if (\n          state.destination.type === entrance.type &&\n          state.destination.id === entrance.id\n        ) {\n          targets = [entrance];\n        }\n      });\n\n      // If the destination entrance wasn't found, route to all entrances\n      if (!targets.length) {\n        targets = state.entrances;\n      }\n\n      // Clear previous routing results by setting an empty result set\n      setState(\n        (prevState): State => ({\n          ...prevState,\n          route: geometryToGeoJSON(),\n        })\n      );\n\n      // Try to find an intermediary point on the street near the destination\n      if (\n        !state.origin ||\n        distance(state.origin, destinationToLatLng(state.destination)) >=\n          maxRoutingDistance\n      ) {\n        let target;\n        let streetName;\n        if (state.destination.tags?.[\"addr:street\"]) {\n          target = state.destination;\n          streetName = state.destination.tags?.[\"addr:street\"];\n        } else {\n          [target] = targets; // Pick a random entrance\n          streetName = target.tags?.[\"addr:street\"];\n        }\n        if (streetName) {\n          const streetGeometry = await queryMatchingStreet(target, streetName);\n          const point = turfNearestPointOnLine(streetGeometry, [\n            target.lon,\n            target.lat,\n          ]).geometry.coordinates;\n          origin = [point[1], point[0]];\n        }\n      }\n\n      // Don't calculate routes if there was no origin and none was found either\n      if (!origin) {\n        return;\n      }\n\n      // If the distance is still more than 200 meters apart\n      // Show an error and proposed actions\n      if (\n        origin === state.origin /* For typechecker */ &&\n        distance(origin, destinationToLatLng(state.destination)) >=\n          maxRoutingDistance\n      ) {\n        const message = state.isOriginExplicit\n          ? \"Origin is too far for showing routes.\"\n          : \"Routes show when distance is shorter.\";\n        const snackbar = enqueueSnackbar(message, {\n          variant: \"info\",\n          persist: true,\n          anchorOrigin: {\n            vertical: \"bottom\",\n            horizontal: \"center\",\n          },\n          action: (\n            <>\n              {state.isOriginExplicit && (\n                <Button\n                  color=\"inherit\"\n                  onClick={(): void => {\n                    setState(\n                      (prevState): State => ({\n                        ...prevState,\n                        origin: prevState.geolocationPosition || undefined,\n                        isOriginExplicit: false,\n                        viewport: fitMap(prevState.viewport, [\n                          prevState.destination &&\n                            destinationToLatLng(prevState.destination),\n                        ]),\n                      })\n                    );\n                  }}\n                >\n                  Undo origin\n                </Button>\n              )}\n              <Button\n                color=\"inherit\"\n                onClick={(): void => {\n                  setState(\n                    (prevState): State => ({\n                      ...prevState,\n                      destination: undefined,\n                      entrances: [],\n                      viewport: fitMap(prevState.viewport, [prevState.origin]),\n                    })\n                  );\n                }}\n              >\n                Undo destination\n              </Button>\n              <Button\n                color=\"inherit\"\n                target=\"_blank\"\n                rel=\"noreferrer\"\n                href={`https://www.google.com/maps/dir/?api=1&origin=${state.origin[0]},${state.origin[1]}&destination=${state.destination.lat},${state.destination.lon}&travelmode=driving`}\n              >\n                Google Maps\n              </Button>\n\n              <IconButton\n                aria-label=\"close\"\n                onClick={(): void => closeSnackbar(snackbar)}\n              >\n                <CloseIcon />\n              </IconButton>\n            </>\n          ),\n        });\n        setState((prevState): State => ({ ...prevState, snackbar }));\n        return; // Don't calculate routes until the inputs change\n      }\n      await calculatePlan(origin, targets, (geojson) => {\n        setState(\n          (prevState): State => {\n            // don't use the result if the parameters changed meanwhile\n            if (\n              state.origin !== prevState.origin ||\n              state.entrances !== prevState.entrances ||\n              state.destination !== prevState.destination\n            ) {\n              return prevState;\n            }\n            const extendedGeojson = {\n              ...geojson,\n              features: geojson.features.concat(prevState.route.features),\n            };\n            return {\n              ...prevState,\n              route: extendedGeojson,\n            };\n          }\n        );\n      });\n    })().catch((error) => {\n      // eslint-disable-next-line no-console\n      console.error(\"Error while starting route planning:\", error);\n    });\n  }, [state.origin, state.entrances]); // eslint-disable-line react-hooks/exhaustive-deps\n  // XXX: state.destination is missing above as we need to wait for state.entrances to change as well\n\n  // When popup opens, try to fetch data for it from OLMap's API\n  useEffect(() => {\n    (async () => {\n      if (!state.popupCoordinates) return;\n      // Clear previous data\n      setState(\n        (prevState: State): State => {\n          if (prevState.popupCoordinates !== state.popupCoordinates) {\n            return prevState;\n          }\n          return {\n            ...prevState,\n            olmapData: { state: \"loading\" },\n          };\n        }\n      );\n      // Fetch new data\n      const olmapData = await fetchOlmapData(state.popupCoordinates.id);\n      setState(\n        (prevState: State): State => {\n          if (prevState.popupCoordinates !== state.popupCoordinates) {\n            return prevState;\n          }\n          return {\n            ...prevState,\n            olmapData,\n          };\n        }\n      );\n    })().catch((error) => {\n      // eslint-disable-next-line no-console\n      console.error(\"Error while fetching OLMap notes:\", error);\n    });\n  }, [state.popupCoordinates]);\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const handleMapClick = (event: any): void => {\n    // Inspect the topmost feature under click\n    const feature = map.current?.getMap().queryRenderedFeatures(event.point)[0];\n    setState(\n      (prevState): State => {\n        // Typing needed as the compiler is not smart enough.\n        const noHighlights: FeatureCollection = {\n          type: \"FeatureCollection\",\n          features: [],\n        };\n        const clickCoordinates = latLngToDestination([\n          event.lngLat.lat,\n          event.lngLat.lng,\n        ]);\n        // If an entrance was clicked, show details in the popup.\n        if (feature?.properties.entrance) {\n          const [id, type] = feature.properties[\"@id\"].split(\"/\").reverse();\n          const element = {\n            id: parseInt(id, 10),\n            type,\n            lat: feature.geometry.coordinates[1],\n            lon: feature.geometry.coordinates[0],\n            tags: feature.properties,\n          };\n          return {\n            ...prevState,\n            popupCoordinates: element,\n            highlights: noHighlights,\n          };\n        }\n        // If a barrier or steps were clicked, show details in the popup.\n        if (\n          feature?.properties.barrier ||\n          feature?.properties.highway === \"steps\"\n        ) {\n          const id = feature.properties[\"@id\"].split(\"/\").reverse()[0];\n          const [lon, lat] =\n            feature.geometry.type === \"Point\"\n              ? feature.geometry.coordinates\n              : turfNearestPointOnLine(feature, event.lngLat.toArray()).geometry\n                  .coordinates;\n          return {\n            ...prevState,\n            popupCoordinates: {\n              id,\n              type: feature.properties[\"@type\"],\n              lat,\n              lon,\n              tags: feature.properties,\n            },\n            highlights: noHighlights,\n          };\n        }\n        // If the popup is open, close it.\n        if (prevState.popupCoordinates != null) {\n          return {\n            ...prevState,\n            popupCoordinates: null,\n            highlights: noHighlights,\n          };\n        }\n        // If a building was clicked, highlight it.\n        if (feature?.sourceLayer === \"building\") {\n          return {\n            ...prevState,\n            popupCoordinates: clickCoordinates,\n            highlights: feature.toJSON(),\n          };\n        }\n        // Otherwise open a plain popup.\n        return {\n          ...prevState,\n          popupCoordinates: clickCoordinates,\n          highlights: noHighlights,\n        };\n      }\n    );\n  };\n\n  const getOlmapId = (\n    olmapData?: NetworkState<OlmapResponse>\n  ): number | false =>\n    olmapData?.state === \"success\" && olmapData.response.image_notes?.[0]?.id;\n\n  const setEditingNote = (event: React.MouseEvent<HTMLElement>): void => {\n    const noteId = getOlmapId(state.olmapData);\n    if (noteId) {\n      setState(\n        (prevState): State => ({\n          ...prevState,\n          editingNote: noteId,\n        })\n      );\n      event.preventDefault();\n    }\n  };\n\n  const getOlmapUrl = (\n    popupCoordinates: ElementWithCoordinates,\n    olmapData?: NetworkState<OlmapResponse>\n  ): string | null => {\n    if (olmapData?.state === \"loading\") {\n      return null;\n    }\n    const noteId = getOlmapId(olmapData);\n    if (!noteId) {\n      return olmapNewNoteURL(popupCoordinates);\n    }\n    return olmapNoteURL(noteId);\n  };\n\n  /**\n   * Two tasks:\n   * - update geolocation position into state\n   * - change origin if deemed appropriate\n   */\n  const onGeolocate = (position: GeolocationPosition): void =>\n    setState(\n      (prevState): State => {\n        if (prevState.isGeolocating) {\n          const isFirstPosition = prevState.geolocationPosition == null;\n          const geolocationPosition: LatLng = [\n            position.coords.latitude,\n            position.coords.longitude,\n          ];\n          const viewport =\n            isFirstPosition && !prevState.isOriginExplicit\n              ? fitMap(prevState.viewport, [\n                  geolocationPosition,\n                  prevState.destination &&\n                    destinationToLatLng(prevState.destination),\n                ])\n              : prevState.viewport;\n          const updateBase = { ...prevState, geolocationPosition, viewport };\n          if (\n            !prevState.isOriginExplicit &&\n            (prevState.origin == null ||\n              distance(prevState.origin, geolocationPosition) > 20)\n          ) {\n            return { ...updateBase, origin: geolocationPosition };\n          }\n          return updateBase;\n        }\n        return prevState;\n      }\n    );\n\n  return (\n    <div data-testid=\"app\" className=\"App\">\n      <header className=\"App-header\">\n        <h2>Gatesolve</h2>\n      </header>\n      <div className=\"App-shadow\" />\n      <ReactAutosuggestGeocoder\n        ref={geocoder}\n        url=\"https://api.digitransit.fi/geocoding/v1\"\n        sources=\"oa,osm,nlsfi\"\n        highlightFirstSuggestion\n        inputProps={{ placeholder: \"Destination name or address\" }}\n        center={{\n          latitude:\n            state.geolocationPosition?.[0] ||\n            state.origin?.[0] ||\n            state.destination?.lat ||\n            metropolitanAreaCenter[0],\n          longitude:\n            state.geolocationPosition?.[1] ||\n            state.origin?.[1] ||\n            state.destination?.lon ||\n            metropolitanAreaCenter[1],\n        }}\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        onSuggestionSelected={(event: any, { suggestion }: any): any => {\n          // react-autosuggest will focus, we need to blur afterwards\n          setTimeout(() => {\n            geocoder.current.blur();\n          });\n          const destination: LatLng = [\n            suggestion.geometry.coordinates[1],\n            suggestion.geometry.coordinates[0],\n          ];\n          const [type, id] = suggestion.properties.source_id.split(\":\");\n          setState(\n            (prevState): State => {\n              const pointsToFit =\n                prevState.origin &&\n                distance(prevState.origin, destination) < maxRoutingDistance\n                  ? [prevState.origin, destination]\n                  : [destination];\n              const viewport = fitMap(prevState.viewport, pointsToFit);\n              return {\n                ...prevState,\n                origin: prevState.origin,\n                destination: {\n                  lat: destination[0],\n                  lon: destination[1],\n                  type,\n                  id: Number(id),\n                  tags: {\n                    \"addr:street\": suggestion.properties.street,\n                  },\n                },\n                entrances: [],\n                viewport: { ...prevState.viewport, ...viewport },\n              };\n            }\n          );\n        }}\n      />\n      <MapGL\n        ref={map}\n        // This is according to the Get Started materials:\n        // https://uber.github.io/react-map-gl/docs/get-started/get-started/\n        // eslint-disable-next-line react/jsx-props-no-spreading\n        {...state.viewport}\n        style={{ width: \"100%\", height: \"90%\" }}\n        mapStyle=\"https://raw.githubusercontent.com/HSLdevcom/hsl-map-style/master/simple-style.json\"\n        dragRotate={false}\n        transformRequest={transformRequest}\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        onViewportChange={(viewport: any): void => {\n          setState((prevState): State => ({ ...prevState, viewport }));\n        }}\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        onHover={(event: any): void => {\n          // Inspect the topmost feature under click\n          const feature = event.features?.[0];\n          // Set cursor shape depending whether we would click an entrance\n          const cursor = feature?.properties.entrance ? \"pointer\" : \"grab\";\n          // FIXME: Better way to set the pointer shape or at least find the element\n          const mapboxOverlaysElement = document.querySelector(\n            \".overlays\"\n          ) as HTMLElement;\n          if (mapboxOverlaysElement) {\n            mapboxOverlaysElement.style.cursor = cursor;\n          }\n        }}\n        onClick={handleMapClick}\n        onContextmenu={handleMapClick}\n      >\n        <GeolocateControl\n          dataTestId=\"geolocate-control\"\n          enableOnMount\n          onEnable={(isInitiatedByUser): void => {\n            setState((prevState) => ({\n              ...prevState,\n              isOriginExplicit:\n                !isInitiatedByUser && prevState.isOriginExplicit,\n              isGeolocating: true,\n            }));\n          }}\n          onDisable={(): void => {\n            setState((prevState) => ({\n              ...prevState,\n              isGeolocating: false,\n              geolocationPosition: null,\n            }));\n          }}\n          onGeolocate={onGeolocate}\n        />\n        {state.geolocationPosition != null && (\n          <Marker\n            offset={[-20, -20]}\n            longitude={state.geolocationPosition[1]}\n            latitude={state.geolocationPosition[0]}\n          >\n            <UserPosition dataTestId=\"user-marker\" />\n          </Marker>\n        )}\n        {Array.from(\n          state.routableTiles.entries(),\n          ([coords, tile]) =>\n            tile && (\n              <Source\n                key={coords}\n                id={`source-${coords}`}\n                type=\"geojson\"\n                data={tile}\n              >\n                {allEntrancesLayers.map((layer) => (\n                  <Layer\n                    // eslint-disable-next-line react/jsx-props-no-spreading\n                    {...layer}\n                    key={`${layer.id}-${coords}`}\n                    id={`${layer.id}-${coords}`}\n                    source={`source-${coords}`}\n                  />\n                ))}\n              </Source>\n            )\n        )}\n        <Source id=\"highlights\" type=\"geojson\" data={state.highlights}>\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...buildingHighlightLayer}\n            source=\"highlights\"\n          />\n        </Source>\n\n        <Source id=\"route\" type=\"geojson\" data={state.route}>\n          {routeLineLayers.map((layer) => (\n            <Layer\n              // eslint-disable-next-line react/jsx-props-no-spreading\n              {...layer}\n              key={layer.id}\n              source=\"route\"\n              before=\"building-highlight\"\n            />\n          ))}\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routeImaginaryLineLayer}\n            source=\"route\"\n          />\n\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routePointLayer}\n            source=\"route\"\n          />\n          <Layer\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...routePointSymbolLayer}\n            source=\"route\"\n          />\n        </Source>\n        {state.origin && (\n          <Marker\n            className=\"PinMarker\"\n            draggable\n            offset={[0, -22.5]}\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            onDragEnd={(lngLat: any): void => {\n              setState(\n                (prevState): State => ({\n                  ...prevState,\n                  origin: [lngLat.lat, lngLat.lng],\n                  isOriginExplicit: true,\n                })\n              );\n            }}\n            longitude={state.origin[1]}\n            latitude={state.origin[0]}\n          >\n            <Pin\n              dataTestId=\"origin\"\n              style={{ fill: \"#00afff\", stroke: \"#fff\" }}\n            />\n          </Marker>\n        )}\n        {state.destination && (\n          <Marker\n            className=\"PinMarker\"\n            draggable\n            offset={[0, -22.5]}\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            onDragEnd={(lngLat: any): void => {\n              geocoder.current.clear();\n              setState(\n                (prevState): State => ({\n                  ...prevState,\n                  destination: latLngToDestination([lngLat.lat, lngLat.lng]),\n                })\n              );\n            }}\n            longitude={state.destination.lon}\n            latitude={state.destination.lat}\n          >\n            <Pin\n              dataTestId=\"destination\"\n              style={{\n                fill: \"#64be14\",\n                stroke: \"#fff\",\n              }}\n            />\n          </Marker>\n        )}\n        {state.popupCoordinates && (\n          <Popup\n            open={state.popupCoordinates != null}\n            latitude={state.popupCoordinates?.lat || null}\n            longitude={state.popupCoordinates?.lon || null}\n            closeButton={false}\n            closeOnClick={false}\n          >\n            <div\n              style={{\n                display: \"grid\",\n                gridTemplateColumns: \"30px 1fr 30px\",\n              }}\n            >\n              <div />\n              <div\n                style={{\n                  fontSize: \"14px\",\n                  fontWeight: \"bold\",\n                }}\n              >\n                {state.popupCoordinates.tags?.[\"addr:street\"]}{\" \"}\n                {state.popupCoordinates.tags?.[\"addr:housenumber\"]}{\" \"}\n                {state.popupCoordinates.tags?.[\"ref\"] ||\n                  state.popupCoordinates.tags?.[\"addr:unit\"]}\n              </div>\n              <div\n                style={{\n                  textAlign: \"right\",\n                }}\n              >\n                <a\n                  aria-label=\"Comment\"\n                  href={\n                    getOlmapUrl(state.popupCoordinates, state.olmapData) || \"#\"\n                  }\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  style={{ display: \"inline-flex\" }}\n                  onClick={setEditingNote}\n                >\n                  <AddCommentIcon\n                    style={{\n                      color: \"#ff5000\",\n                      backgroundColor: \"#fff\",\n                    }}\n                  />\n                </a>\n              </div>\n            </div>\n            <OLMapImages\n              onImageClick={setEditingNote}\n              olmapData={state.olmapData}\n            />\n            {state.popupCoordinates.tags && (\n              <table\n                style={{\n                  marginTop: \"10px\",\n                  marginBottom: \"10px\",\n                  textAlign: \"left\",\n                }}\n              >\n                <tbody>\n                  {Object.entries(state.popupCoordinates.tags)\n                    .filter(\n                      ([k]) =>\n                        !k.startsWith(\"@\") &&\n                        ![\n                          \"addr:street\",\n                          \"addr:housenumber\",\n                          \"addr:unit\",\n                          \"ref\",\n                        ].includes(k)\n                    )\n                    .map(([k, v]) => (\n                      <tr key={`${k}-${v}`}>\n                        <td\n                          style={{\n                            padding: \"0 5px 0 0\",\n                            textAlign: \"right\",\n                          }}\n                        >\n                          {k}\n                        </td>\n                        <td>{v}</td>\n                      </tr>\n                    ))}\n                </tbody>\n              </table>\n            )}\n            <div\n              style={{\n                display: \"flex\",\n                justifyContent: \"center\",\n              }}\n            >\n              <Button\n                data-testid=\"origin-button\"\n                variant=\"contained\"\n                size=\"small\"\n                style={{ backgroundColor: \"#00afff\", color: \"#fff\" }}\n                type=\"button\"\n                aria-label=\"Set origin\"\n                onClick={(): void =>\n                  setState(\n                    (prevState): State => {\n                      // Check this to appease the compiler.\n                      if (prevState.popupCoordinates != null) {\n                        return {\n                          ...prevState,\n                          origin: destinationToLatLng(\n                            prevState.popupCoordinates\n                          ),\n                          isOriginExplicit: true,\n                          popupCoordinates: null,\n                        };\n                      }\n                      return {\n                        ...prevState,\n                        isOriginExplicit: true,\n                        popupCoordinates: null,\n                      };\n                    }\n                  )\n                }\n              >\n                Origin\n              </Button>\n              <span style={{ padding: \"5px\" }} />\n              <Button\n                data-testid=\"destination-button\"\n                variant=\"contained\"\n                size=\"small\"\n                style={{ backgroundColor: \"#64be14\", color: \"#fff\" }}\n                type=\"button\"\n                aria-label=\"Set destination\"\n                onClick={(): void =>\n                  setState(\n                    (prevState): State => {\n                      // Check this to appease the compiler.\n                      if (prevState.popupCoordinates != null) {\n                        return {\n                          ...prevState,\n                          destination: prevState.popupCoordinates,\n                          popupCoordinates: null,\n                        };\n                      }\n                      return {\n                        ...prevState,\n                        popupCoordinates: null,\n                      };\n                    }\n                  )\n                }\n              >\n                Destination\n              </Button>\n            </div>\n          </Popup>\n        )}\n      </MapGL>\n      <OLMapDialog\n        noteId={state.editingNote}\n        onClose={() =>\n          setState((prevState) => ({\n            ...prevState,\n            editingNote: undefined,\n          }))\n        }\n      />\n    </div>\n  );\n};\n\nexport default App;\n"],"sourceRoot":""}